<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen pb-20"></div>

  <script>
    // State Management
    var state = {
      activeTab: 'home',
      transactions: [],
      memos: [],
      events: [],
      goals: { year7: '', year5: '', year3: '', thisYear: '' },
      bankBalances: [],
      investments: [],
      dividends: [],
      investmentJournals: [],
      showAddDividend: false,
      showAddJournal: false,
      dividendPeriod: 'all',
      dividendSearchKeyword: '',
      exchangeTab: 'USD',
      usdPhases: [],
      jpyPhases: [],
      usdRate: 1380,
      jpyRate: 920,
      usdNextId: 1,
      jpyNextId: 1,
      expandedPhase: null,
      showExchangeStats: false,
      exchangeStatsPeriod: 'yearly',
      exchangeStatsStartDate: '',
      exchangeStatsEndDate: '',
      soldItemsVisible: 10,
      usdInitialBudget: 10000000,
      jpyInitialBudget: 10000000,
      categories: {
        expense: ['ì‹ë¹„', 'êµí†µë¹„', 'í†µì‹ ë¹„', 'ìƒí™œìš©í’ˆ', 'ì˜ë£Œë¹„', 'êµìœ¡ë¹„', 'ë¬¸í™”ìƒí™œ', 'ì•„ë²„ì§€', 'ì§€í™˜', 'ë‹¤í˜œ', 'ë‹¤ì—°', 'ë³´í—˜ë£Œ', 'ì™¸ì‹ë¹„', 'ì„¸ê¸ˆê³µê³¼ê¸ˆ', 'ì£¼ìœ ë¹„', 'ê¸°íƒ€ë¹„'],
        income: ['ê¸‰ì—¬', 'ì´ì', 'ëŒ€ë¦¬ì—…ë¬´', 'ë°°ë‹¹ê¸ˆ', 'ê¸°íƒ€ìˆ˜ì…']
      },
      undoStack: [],
      showAddTransaction: false,
      showCompoundCalc: false,
      showSettings: false,
      showAddInvestment: false,
      isLoading: true
    };

    // Storage helpers
    var storage = {
      get: function(key) {
        try {
          var value = localStorage.getItem(key);
          return value ? JSON.parse(value) : null;
        } catch (e) { return null; }
      },
      set: function(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) { console.error('Storage error:', e); }
      }
    };

    // Load data
    function loadData() {
      state.transactions = storage.get('transactions') || [];
      state.memos = storage.get('memos') || [];
      state.events = storage.get('events') || [];
      state.goals = storage.get('goals') || { year7: '', year5: '', year3: '', thisYear: '' };
      state.bankBalances = storage.get('bankBalances') || [];
      state.investments = storage.get('investments') || [];
      state.dividends = storage.get('dividends') || [];
      state.investmentJournals = storage.get('investmentJournals') || [];
      state.categories = storage.get('categories') || state.categories;
      var exchangeData = storage.get('exchangeData');
      if (exchangeData) {
        state.usdPhases = exchangeData.usdPhases || [];
        state.jpyPhases = exchangeData.jpyPhases || [];
        state.usdRate = exchangeData.usdRate || 1380;
        state.jpyRate = exchangeData.jpyRate || 920;
        state.usdNextId = exchangeData.usdNextId || 1;
        state.jpyNextId = exchangeData.jpyNextId || 1;
        state.usdInitialBudget = exchangeData.usdInitialBudget || 10000000;
        state.jpyInitialBudget = exchangeData.jpyInitialBudget || 10000000;
      }
      state.isLoading = false;
      render();
    }

    // Save data
    function saveData() {
      storage.set('transactions', state.transactions);
      storage.set('memos', state.memos);
      storage.set('events', state.events);
      storage.set('goals', state.goals);
      storage.set('bankBalances', state.bankBalances);
      storage.set('investments', state.investments);
      storage.set('dividends', state.dividends);
      storage.set('investmentJournals', state.investmentJournals);
      storage.set('categories', state.categories);
      storage.set('exchangeData', {
        usdPhases: state.usdPhases,
        jpyPhases: state.jpyPhases,
        usdRate: state.usdRate,
        jpyRate: state.jpyRate,
        usdNextId: state.usdNextId,
        jpyNextId: state.jpyNextId,
        usdInitialBudget: state.usdInitialBudget,
        jpyInitialBudget: state.jpyInitialBudget
      });
    }

    // Toast notification
    var toastTimeout;
    function showToast(message, type) {
      type = type || 'success';
      var existing = document.getElementById('toast');
      if (existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-lg z-50 ' + 
        (type === 'error' ? 'bg-red-500' : 'bg-green-500') + ' text-white font-medium animate-fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(function() { toast.remove(); }, 3000);
    }

    // Utility functions
    function formatNumber(num) {
      return num.toLocaleString();
    }

    function getRankInfo(balance) {
      if (balance >= 500000000) return { rank: 'ì ˆëŒ€ê°•ì', color: 'text-purple-600', bgColor: 'bg-purple-100', icon: 'ğŸ‘‘' };
      if (balance >= 200000000) return { rank: 'ì†Œë¶€ì', color: 'text-blue-600', bgColor: 'bg-blue-100', icon: 'ğŸ’' };
      if (balance >= 100000000) return { rank: 'ì¤‘ì‚°ì¸µ', color: 'text-green-600', bgColor: 'bg-green-100', icon: 'ğŸ†' };
      if (balance >= 50000000) return { rank: 'ì„œë¯¼', color: 'text-yellow-600', bgColor: 'bg-yellow-100', icon: 'â­' };
      if (balance >= 10000000) return { rank: 'ì°¨ìƒìœ„ì', color: 'text-orange-600', bgColor: 'bg-orange-100', icon: 'ğŸ”¶' };
      return { rank: 'ê¸°ì´ˆìˆ˜ê¸‰ì', color: 'text-gray-600', bgColor: 'bg-gray-100', icon: 'ğŸŒ±' };
    }

    function getInvestGrade(totalProfit, totalInvested) {
      if (totalInvested === 0) return { grade: 'ì´ˆë³´', color: 'text-gray-600', bg: 'bg-gray-100' };
      var rate = (totalProfit / totalInvested) * 100;
      if (rate < 0) return { grade: 'ì†ì‹¤', color: 'text-gray-700', bg: 'bg-gray-200' };
      if (rate < 10) return { grade: 'í•˜ìˆ˜', color: 'text-blue-700', bg: 'bg-blue-100' };
      if (rate < 20) return { grade: 'ì¤‘ìˆ˜', color: 'text-green-700', bg: 'bg-green-100' };
      if (rate < 30) return { grade: 'ê³ ìˆ˜', color: 'text-purple-700', bg: 'bg-purple-100' };
      if (rate < 50) return { grade: 'ì‹¤ë²„', color: 'text-slate-700', bg: 'bg-slate-200' };
      if (rate < 60) return { grade: 'ê³¨ë“œ', color: 'text-yellow-700', bg: 'bg-yellow-100' };
      return { grade: 'íˆ¬ìì˜ ì‹ ', color: 'text-red-700', bg: 'bg-gradient-to-r from-yellow-200 to-red-200' };
    }

    function addToUndoStack(action, data) {
      state.undoStack.push({ action: action, data: data, timestamp: Date.now() });
      if (state.undoStack.length > 10) state.undoStack.shift();
    }

    function handleUndo() {
      if (state.undoStack.length === 0) return;
      var lastAction = state.undoStack.pop();
      
      if (lastAction.action === 'deleteTransaction') {
        state.transactions.push(lastAction.data);
        showToast('ê±°ë˜ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      } else if (lastAction.action === 'deleteMemo') {
        state.memos.push(lastAction.data);
        showToast('ë©”ëª¨ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      }
      saveData();
      render();
    }

    // Export/Import functions
    function exportData() {
      var data = {
        transactions: state.transactions,
        memos: state.memos,
        goals: state.goals,
        bankBalances: state.bankBalances,
        investments: state.investments,
        dividends: state.dividends,
        investmentJournals: state.investmentJournals,
        events: state.events,
        categories: state.categories,
        exchangeData: {
          usdPhases: state.usdPhases,
          jpyPhases: state.jpyPhases,
          usdRate: state.usdRate,
          jpyRate: state.jpyRate,
          usdNextId: state.usdNextId,
          jpyNextId: state.jpyNextId
        },
        exportDate: new Date().toISOString()
      };
      
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'budget_backup_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showToast('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function exportToCSV() {
      var headers = ['ë‚ ì§œ', 'ìœ í˜•', 'ì¹´í…Œê³ ë¦¬', 'ê¸ˆì•¡', 'ê²°ì œìˆ˜ë‹¨', 'í• ë¶€', 'í•„ìš”ì§€ì¶œ', 'ë©”ëª¨'];
      var rows = state.transactions.map(function(t) {
        return [
          t.date,
          t.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
          t.category,
          t.amount,
          t.paymentMethod === 'card' ? 'ì¹´ë“œ' : 'í˜„ê¸ˆ',
          t.installment || 'ì¼ì‹œë¶ˆ',
          t.isNecessary ? 'í•„ìš”' : 'ë¶ˆí•„ìš”',
          t.memo || ''
        ];
      });

      var csvContent = [headers].concat(rows)
        .map(function(row) { return row.map(function(cell) { return '"' + cell + '"'; }).join(','); })
        .join('\n');

      var BOM = '\uFEFF';
      var blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'ê±°ë˜ë‚´ì—­_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function importData(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var data = JSON.parse(e.target.result);
          if (!data.transactions || !Array.isArray(data.transactions)) {
            throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹');
          }

          if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            state.transactions = data.transactions || [];
            state.memos = data.memos || [];
            state.goals = data.goals || { year7: '', year5: '', year3: '', thisYear: '' };
            state.bankBalances = data.bankBalances || [];
            state.investments = data.investments || [];
            state.dividends = data.dividends || [];
            state.investmentJournals = data.investmentJournals || [];
            state.events = data.events || [];
            if (data.categories) state.categories = data.categories;
            if (data.exchangeData) {
              state.usdPhases = data.exchangeData.usdPhases || [];
              state.jpyPhases = data.exchangeData.jpyPhases || [];
              state.usdRate = data.exchangeData.usdRate || 1380;
              state.jpyRate = data.exchangeData.jpyRate || 920;
              state.usdNextId = data.exchangeData.usdNextId || 1;
              state.jpyNextId = data.exchangeData.jpyNextId || 1;
            }
            saveData();
            render();
            showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Render Header
    function renderHeader() {
      var totalBankBalance = state.bankBalances.reduce(function(sum, b) { return sum + b.balance; }, 0);
      var rankInfo = getRankInfo(totalBankBalance);
      
      return '<div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sticky top-0 z-10 shadow-lg">' +
        '<div class="flex justify-between items-center">' +
          '<h1 class="text-xl font-bold">ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</h1>' +
          '<div class="flex items-center gap-2">' +
            '<button onclick="state.showCompoundCalc=true;render()" class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow-md">ë³µë¦¬</button>' +
            '<button onclick="state.showSettings=true;render()" class="bg-white text-blue-600 p-2 rounded-full hover:bg-blue-50 transition shadow-md">' +
              '<i data-lucide="settings" class="w-4 h-4"></i>' +
            '</button>' +
            '<div class="' + rankInfo.bgColor + ' px-3 py-1 rounded-full flex items-center gap-1 shadow-md">' +
              '<span class="text-base">' + rankInfo.icon + '</span>' +
              '<span class="text-sm font-bold ' + rankInfo.color + '">' + rankInfo.rank + '</span>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Render Home Screen
    function renderHomeScreen() {
      var today = new Date();
      var currentMonth = today.getMonth();
      var currentYear = today.getFullYear();

      var monthlyTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      var totalIncome = monthlyTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var totalExpense = monthlyTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var necessaryExpense = monthlyTx.filter(function(t) { return t.type === 'expense' && t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var unnecessaryExpense = monthlyTx.filter(function(t) { return t.type === 'expense' && !t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);

      var installmentTx = state.transactions.filter(function(t) { return t.installment > 0; });
      var monthlyInstallment = installmentTx.reduce(function(sum, t) {
        var tDate = new Date(t.date);
        var monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        if (monthsSinceStart >= 0 && monthsSinceStart < t.installment) {
          return sum + (t.amount / t.installment);
        }
        return sum;
      }, 0);

      var remainingInstallment = installmentTx.reduce(function(sum, t) {
        var tDate = new Date(t.date);
        var monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        var remainingMonths = Math.max(0, t.installment - monthsSinceStart);
        return sum + (t.amount / t.installment * remainingMonths);
      }, 0);

      var totalBalance = totalIncome - totalExpense;
      var recentTx = state.transactions.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); }).slice(0, 10);

      var recentTxHtml = '';
      if (recentTx.length === 0) {
        recentTxHtml = '<div class="text-center text-gray-400 py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        recentTxHtml = recentTx.map(function(t) {
          return '<div class="flex justify-between items-center py-2 border-b last:border-b-0">' +
            '<div>' +
              '<div class="font-medium">' + t.category + '</div>' +
              '<div class="text-xs text-gray-500">' + t.date + '</div>' +
            '</div>' +
            '<div class="font-bold ' + (t.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
              (t.type === 'income' ? '+' : '-') + formatNumber(t.amount) + 'ì›' +
            '</div>' +
          '</div>';
        }).join('');
      }

      return '<div class="p-4 space-y-4">' +
        '<div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">' +
          '<div class="text-sm opacity-90 mb-1">ì´ ì”ì•¡</div>' +
          '<div class="text-3xl font-bold mb-3">' + formatNumber(totalBalance) + 'ì›</div>' +
          (state.undoStack.length > 0 ? 
            '<button onclick="handleUndo()" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">' +
              '<i data-lucide="undo-2" class="w-4 h-4"></i> ì‹¤í–‰ ì·¨ì†Œ' +
            '</button>' : '') +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">' +
            '<div class="text-xs text-green-600 mb-1">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>' +
            '<div class="text-xl font-bold text-green-700">' + formatNumber(totalIncome) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm">' +
            '<div class="text-xs text-red-600 mb-1">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>' +
            '<div class="text-xl font-bold text-red-700">' + formatNumber(totalExpense) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-purple-50 p-4 rounded-lg border border-purple-200 shadow-sm">' +
            '<div class="text-xs text-purple-600 mb-1">ì´ë²ˆ ë‹¬ í• ë¶€</div>' +
            '<div class="text-lg font-bold text-purple-700">' + formatNumber(Math.round(monthlyInstallment)) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-orange-50 p-4 rounded-lg border border-orange-200 shadow-sm">' +
            '<div class="text-xs text-orange-600 mb-1">ë‚¨ì€ í• ë¶€</div>' +
            '<div class="text-lg font-bold text-orange-700">' + formatNumber(Math.round(remainingInstallment)) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">' +
            '<div class="text-xs text-blue-600 mb-1">í•„ìš” ì§€ì¶œ</div>' +
            '<div class="text-lg font-bold text-blue-700">' + formatNumber(necessaryExpense) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">' +
            '<div class="text-xs text-gray-600 mb-1">ë¶ˆí•„ìš” ì§€ì¶œ</div>' +
            '<div class="text-lg font-bold text-gray-700">' + formatNumber(unnecessaryExpense) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h3 class="font-bold">ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>' +
            '<div class="flex gap-2">' +
              '<button onclick="exportToCSV()" class="text-blue-600 text-sm flex items-center gap-1">' +
                '<i data-lucide="download" class="w-3.5 h-3.5"></i> CSV' +
              '</button>' +
              '<button onclick="exportData()" class="text-blue-600 text-sm flex items-center gap-1">' +
                '<i data-lucide="share-2" class="w-3.5 h-3.5"></i> ë°±ì—…' +
              '</button>' +
            '</div>' +
          '</div>' +
          '<div class="space-y-2">' + recentTxHtml + '</div>' +
        '</div>' +
      '</div>';
    }

    // History Screen
    function renderHistoryScreen() {
      return '<div class="p-4" id="history-screen">' +
        '<div class="mb-4 space-y-2">' +
          '<div class="grid grid-cols-2 gap-2">' +
            '<div><label class="block text-xs text-gray-600 mb-1">ì‹œì‘ì¼</label><input type="date" id="startDate" class="w-full p-2 border rounded text-sm"></div>' +
            '<div><label class="block text-xs text-gray-600 mb-1">ì¢…ë£Œì¼</label><input type="date" id="endDate" class="w-full p-2 border rounded text-sm"></div>' +
          '</div>' +
          '<input type="text" id="searchKeyword" class="w-full p-2 border rounded" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰">' +
        '</div>' +
        '<div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">' +
          '<button onclick="setHistoryPeriod(\'daily\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="daily">ì¼ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'weekly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'monthly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="monthly">ì›”ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'yearly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>' +
        '</div>' +
        '<div id="history-list" class="space-y-4"></div>' +
      '</div>';
    }

    var historyPeriod = 'daily';

    function setHistoryPeriod(period) {
      historyPeriod = period;
      document.querySelectorAll('.period-btn').forEach(function(btn) {
        if (btn.dataset.period === period) {
          btn.className = 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md';
        } else {
          btn.className = 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
        }
      });
      updateHistoryList();
    }

    function updateHistoryList() {
      var startDate = document.getElementById('startDate') ? document.getElementById('startDate').value : '';
      var endDate = document.getElementById('endDate') ? document.getElementById('endDate').value : '';
      var keyword = document.getElementById('searchKeyword') ? document.getElementById('searchKeyword').value : '';

      var filtered = state.transactions.filter(function(t) {
        var tDate = new Date(t.date);
        var start = startDate ? new Date(startDate) : null;
        var end = endDate ? new Date(endDate) : null;
        var dateMatch = (!start || tDate >= start) && (!end || tDate <= end);
        var keywordMatch = !keyword || t.category.indexOf(keyword) >= 0 || (t.memo && t.memo.indexOf(keyword) >= 0);
        return dateMatch && keywordMatch;
      });

      var grouped = {};
      filtered.forEach(function(t) {
        var date = new Date(t.date);
        var key;
        if (historyPeriod === 'daily') key = t.date;
        else if (historyPeriod === 'weekly') {
          var weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        } else if (historyPeriod === 'monthly') {
          key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        } else {
          key = String(date.getFullYear());
        }
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      var listEl = document.getElementById('history-list');
      if (!listEl) return;

      if (Object.keys(grouped).length === 0) {
        listEl.innerHTML = '<div class="text-center text-gray-400 py-8">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      listEl.innerHTML = Object.keys(grouped).sort().reverse().map(function(period) {
        var txs = grouped[period];
        var income = txs.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
        var expense = txs.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
        var balance = income - expense;

        return '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="mb-3">' +
            '<h3 class="font-bold text-lg mb-2">' + period + '</h3>' +
            '<div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg">' +
              '<div><div class="text-xs text-green-600">ìˆ˜ì…</div><div class="text-sm font-bold text-green-700">' + formatNumber(income) + 'ì›</div></div>' +
              '<div><div class="text-xs text-red-600">ì§€ì¶œ</div><div class="text-sm font-bold text-red-700">' + formatNumber(expense) + 'ì›</div></div>' +
              '<div><div class="text-xs text-blue-600">ì”ê³ </div><div class="text-sm font-bold ' + (balance >= 0 ? 'text-blue-700' : 'text-red-700') + '">' + formatNumber(balance) + 'ì›</div></div>' +
            '</div>' +
          '</div>' +
          txs.map(function(t) {
            return '<div class="border-b py-2 last:border-b-0">' +
              '<div class="flex justify-between items-center">' +
                '<div class="flex-1">' +
                  '<div class="font-medium">' + t.category + '</div>' +
                  '<div class="text-xs text-gray-500">' + t.date + (t.memo ? ' - ' + t.memo : '') + '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  '<div class="font-bold ' + (t.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
                    (t.type === 'income' ? '+' : '-') + formatNumber(t.amount) + 'ì›' +
                  '</div>' +
                  '<button onclick="editTransaction(' + t.id + ')" class="text-blue-500 text-sm px-1">ìˆ˜ì •</button>' +
                  '<button onclick="deleteTransaction(' + t.id + ')" class="text-red-500 text-sm px-1">ì‚­ì œ</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('') +
        '</div>';
      }).join('');
    }

    function deleteTransaction(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        var tx = state.transactions.find(function(t) { return t.id === id; });
        if (tx) addToUndoStack('deleteTransaction', tx);
        state.transactions = state.transactions.filter(function(t) { return t.id !== id; });
        saveData();
        updateHistoryList();
        showToast('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function editTransaction(id) {
      var tx = state.transactions.find(function(t) { return t.id === id; });
      if (!tx) return;
      
      var newAmount = prompt('ê¸ˆì•¡:', tx.amount);
      if (newAmount === null) return;
      
      var newCategory = prompt('ì¹´í…Œê³ ë¦¬:', tx.category);
      if (newCategory === null) return;
      
      var newMemo = prompt('ë©”ëª¨:', tx.memo || '');
      if (newMemo === null) return;
      
      tx.amount = Number(newAmount) || tx.amount;
      tx.category = newCategory || tx.category;
      tx.memo = newMemo;
      
      saveData();
      updateHistoryList();
      showToast('ê±°ë˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // Stats Screen
    function renderStatsScreen() {
      return '<div class="p-4" id="stats-screen">' +
        '<div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">' +
          '<button onclick="setStatsPeriod(\'daily\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="daily">ì¼ë³„</button>' +
          '<button onclick="setStatsPeriod(\'weekly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>' +
          '<button onclick="setStatsPeriod(\'monthly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="monthly">ì›”ë³„</button>' +
          '<button onclick="setStatsPeriod(\'yearly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>' +
        '</div>' +
        '<button onclick="showComprehensiveAIAnalysis()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold mb-4 flex items-center justify-center gap-2 hover:from-purple-700 hover:to-indigo-700 transition shadow-lg">' +
          '<span class="text-xl">ğŸ¤–</span><span>AI ì¢…í•© ì¬ì • ë¶„ì„</span>' +
        '</button>' +
        '<div id="stats-content"></div>' +
        '<div id="ai-analysis-content" class="hidden"></div>' +
      '</div>';
    }

    var statsPeriod = 'monthly';
    var showingAIAnalysis = false;

    function setStatsPeriod(period) {
      statsPeriod = period;
      document.querySelectorAll('.stats-btn').forEach(function(btn) {
        if (btn.dataset.period === period) {
          btn.className = 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md';
        } else {
          btn.className = 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
        }
      });
      updateStatsContent();
    }

    function updateStatsContent() {
      var now = new Date();
      var filtered = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        if (statsPeriod === 'daily') return d.toDateString() === now.toDateString();
        if (statsPeriod === 'weekly') return d >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        if (statsPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        return d.getFullYear() === now.getFullYear();
      });

      var categoryStats = {};
      filtered.forEach(function(t) {
        if (!categoryStats[t.category]) categoryStats[t.category] = { income: 0, expense: 0 };
        if (t.type === 'income') categoryStats[t.category].income += t.amount;
        else categoryStats[t.category].expense += t.amount;
      });

      var totalIncome = filtered.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var totalExpense = filtered.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var maxAmount = Math.max(totalIncome, totalExpense, 1);

      var contentEl = document.getElementById('stats-content');
      if (!contentEl) return;

      var categoryHtml = '';
      if (Object.keys(categoryStats).length === 0) {
        categoryHtml = '<div class="text-center text-gray-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        categoryHtml = Object.entries(categoryStats).map(function(entry) {
          var cat = entry[0];
          var amounts = entry[1];
          var html = '<div class="border-b pb-3"><div class="font-medium mb-2">' + cat + '</div>';
          if (amounts.income > 0) {
            html += '<div class="mb-1">' +
              '<div class="flex justify-between text-xs mb-1">' +
                '<span class="text-green-600">ìˆ˜ì…</span>' +
                '<span class="text-green-600 font-bold">' + formatNumber(amounts.income) + 'ì›</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-4">' +
                '<div class="bg-green-400 h-4 rounded-full transition-all" style="width: ' + (amounts.income / maxAmount * 100) + '%"></div>' +
              '</div>' +
            '</div>';
          }
          if (amounts.expense > 0) {
            html += '<div>' +
              '<div class="flex justify-between text-xs mb-1">' +
                '<span class="text-red-600">ì§€ì¶œ</span>' +
                '<span class="text-red-600 font-bold">' + formatNumber(amounts.expense) + 'ì›</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-4">' +
                '<div class="bg-red-400 h-4 rounded-full transition-all" style="width: ' + (amounts.expense / maxAmount * 100) + '%"></div>' +
              '</div>' +
            '</div>';
          }
          html += '</div>';
          return html;
        }).join('');
      }

      contentEl.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-4 mb-4">' +
        '<h3 class="font-bold mb-4">ìˆ˜ì… / ì§€ì¶œ í•©ê³„</h3>' +
        '<div class="space-y-4">' +
          '<div>' +
            '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-green-600 font-medium">ìˆ˜ì…</span>' +
              '<span class="text-green-600 font-bold">' + formatNumber(totalIncome) + 'ì›</span>' +
            '</div>' +
            '<div class="w-full bg-gray-200 rounded-full h-6">' +
              '<div class="bg-gradient-to-r from-green-400 to-green-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ' + (totalIncome / maxAmount * 100) + '%">' +
                '<span class="text-xs text-white font-bold">' + Math.round(totalIncome / maxAmount * 100) + '%</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-red-600 font-medium">ì§€ì¶œ</span>' +
              '<span class="text-red-600 font-bold">' + formatNumber(totalExpense) + 'ì›</span>' +
            '</div>' +
            '<div class="w-full bg-gray-200 rounded-full h-6">' +
              '<div class="bg-gradient-to-r from-red-400 to-red-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ' + (totalExpense / maxAmount * 100) + '%">' +
                '<span class="text-xs text-white font-bold">' + Math.round(totalExpense / maxAmount * 100) + '%</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="bg-white rounded-xl shadow-lg p-4">' +
        '<h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</h3>' +
        '<div class="space-y-3">' + categoryHtml + '</div>' +
      '</div>';
    }

    function showAIAnalysis() {
      showingAIAnalysis = !showingAIAnalysis;
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      
      if (showingAIAnalysis) {
        if (statsContent) statsContent.classList.add('hidden');
        if (aiContent) {
          aiContent.classList.remove('hidden');
          generateAIAnalysis();
        }
      } else {
        if (statsContent) statsContent.classList.remove('hidden');
        if (aiContent) aiContent.classList.add('hidden');
      }
    }

    function showComprehensiveAIAnalysis() {
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      
      if (statsContent) statsContent.classList.add('hidden');
      if (aiContent) {
        aiContent.classList.remove('hidden');
        generateComprehensiveAIAnalysis();
      }
    }

    function generateComprehensiveAIAnalysis() {
      var aiContent = document.getElementById('ai-analysis-content');
      if (!aiContent) return;

      var now = new Date();
      var thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      var lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
      var threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
      var yearStart = new Date(now.getFullYear(), 0, 1);

      // This month data
      var thisMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= thisMonthStart; });
      var thisMonthIncome = thisMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthExpense = thisMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthNecessary = thisMonthTx.filter(function(t) { return t.type === 'expense' && t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthUnnecessary = thisMonthTx.filter(function(t) { return t.type === 'expense' && !t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // Last month data
      var lastMonthTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d >= lastMonthStart && d <= lastMonthEnd;
      });
      var lastMonthIncome = lastMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthExpense = lastMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // 3 month average
      var threeMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= threeMonthsAgo; });
      var threeMonthIncome = threeMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0) / 3;
      var threeMonthExpense = threeMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0) / 3;

      // Year data
      var yearTx = state.transactions.filter(function(t) { return new Date(t.date) >= yearStart; });
      var yearIncome = yearTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var yearExpense = yearTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // Savings rate
      var savingsRate = thisMonthIncome > 0 ? ((thisMonthIncome - thisMonthExpense) / thisMonthIncome * 100) : 0;
      var lastSavingsRate = lastMonthIncome > 0 ? ((lastMonthIncome - lastMonthExpense) / lastMonthIncome * 100) : 0;

      // Changes
      var incomeChange = lastMonthIncome > 0 ? ((thisMonthIncome - lastMonthIncome) / lastMonthIncome * 100) : 0;
      var expenseChange = lastMonthExpense > 0 ? ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100) : 0;

      // Category analysis
      var expenseByCategory = {};
      thisMonthTx.filter(function(t) { return t.type === 'expense'; }).forEach(function(t) {
        if (!expenseByCategory[t.category]) expenseByCategory[t.category] = 0;
        expenseByCategory[t.category] += t.amount;
      });
      var sortedCategories = Object.entries(expenseByCategory).sort(function(a, b) { return b[1] - a[1]; });

      var incomeByCategory = {};
      thisMonthTx.filter(function(t) { return t.type === 'income'; }).forEach(function(t) {
        if (!incomeByCategory[t.category]) incomeByCategory[t.category] = 0;
        incomeByCategory[t.category] += t.amount;
      });
      var sortedIncomeCategories = Object.entries(incomeByCategory).sort(function(a, b) { return b[1] - a[1]; });

      // Bank balance analysis
      var totalBankBalance = state.bankBalances.reduce(function(s, b) { return s + b.balance; }, 0);
      var rankInfo = getRankInfo(totalBankBalance);

      // Investment analysis
      var totalInvested = state.investments.reduce(function(s, i) { return s + i.buyPrice * i.quantity; }, 0);
      var totalCurrentValue = state.investments.reduce(function(s, i) { return s + i.currentPrice * i.quantity; }, 0);
      var investmentProfit = totalCurrentValue - totalInvested;
      var investmentProfitRate = totalInvested > 0 ? (investmentProfit / totalInvested * 100) : 0;
      var totalDividends = state.dividends.reduce(function(s, d) { return s + d.amount; }, 0);

      // Investment by type
      var investmentByType = {};
      state.investments.forEach(function(inv) {
        var typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
        var label = typeLabels[inv.type] || 'ê¸°íƒ€';
        if (!investmentByType[label]) investmentByType[label] = { invested: 0, current: 0 };
        investmentByType[label].invested += inv.buyPrice * inv.quantity;
        investmentByType[label].current += inv.currentPrice * inv.quantity;
      });

      // Exchange rate analysis
      var usdSold = state.usdPhases.filter(function(p) { return p.sold; });
      var jpySold = state.jpyPhases.filter(function(p) { return p.sold; });
      var usdProfit = usdSold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var jpyProfit = jpySold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var usdInvested = usdSold.reduce(function(s, p) { return s + p.amount; }, 0);
      var jpyInvested = jpySold.reduce(function(s, p) { return s + p.amount; }, 0);
      var usdProfitRate = usdInvested > 0 ? (usdProfit / usdInvested * 100) : 0;
      var jpyProfitRate = jpyInvested > 0 ? (jpyProfit / jpyInvested * 100) : 0;

      var usdHolding = state.usdPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var jpyHolding = state.jpyPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);

      // Health score calculation
      var healthScore = 100;
      if (savingsRate < 20) healthScore -= 15;
      if (savingsRate < 10) healthScore -= 15;
      if (savingsRate < 0) healthScore -= 20;
      if (expenseChange > 20) healthScore -= 15;
      if (thisMonthUnnecessary > thisMonthNecessary) healthScore -= 10;
      if (investmentProfitRate < 0) healthScore -= 10;
      healthScore = Math.max(0, Math.min(100, healthScore));

      var healthEmoji = healthScore >= 80 ? 'ğŸ˜Š' : healthScore >= 60 ? 'ğŸ™‚' : healthScore >= 40 ? 'ğŸ˜' : 'ğŸ˜Ÿ';
      var healthColor = healthScore >= 80 ? 'from-green-500 to-emerald-500' : healthScore >= 60 ? 'from-blue-500 to-cyan-500' : healthScore >= 40 ? 'from-yellow-500 to-orange-500' : 'from-red-500 to-pink-500';

      // Goal analysis
      var goals = [
        { label: '7ë…„ ëª©í‘œ', value: Number(state.goals.year7) || 0 },
        { label: '5ë…„ ëª©í‘œ', value: Number(state.goals.year5) || 0 },
        { label: '3ë…„ ëª©í‘œ', value: Number(state.goals.year3) || 0 },
        { label: 'ì˜¬í•´ ëª©í‘œ', value: Number(state.goals.thisYear) || 0 }
      ];
      var activeGoal = goals.find(function(g) { return g.value > 0; });
      var goalProgress = activeGoal ? Math.min((totalBankBalance / activeGoal.value) * 100, 100) : 0;

      // Generate recommendations
      var recommendations = [];
      if (savingsRate < 20) {
        recommendations.push({ type: 'warning', icon: 'âš ï¸', text: 'ì €ì¶•ë¥ ì´ ' + savingsRate.toFixed(1) + '%ì…ë‹ˆë‹¤. 20% ì´ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.' });
      } else {
        recommendations.push({ type: 'success', icon: 'âœ…', text: 'ì €ì¶•ë¥  ' + savingsRate.toFixed(1) + '%ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤!' });
      }
      if (expenseChange > 10) {
        recommendations.push({ type: 'warning', icon: 'ğŸš¨', text: 'ì§€ì¶œì´ ì „ì›” ëŒ€ë¹„ ' + expenseChange.toFixed(1) + '% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.' });
      }
      if (thisMonthUnnecessary > thisMonthExpense * 0.3) {
        recommendations.push({ type: 'warning', icon: 'ğŸ’¸', text: 'ë¶ˆí•„ìš” ì§€ì¶œ ë¹„ìœ¨ì´ ' + (thisMonthUnnecessary / thisMonthExpense * 100).toFixed(1) + '%ì…ë‹ˆë‹¤. ì¤„ì—¬ë³´ì„¸ìš”.' });
      }
      if (sortedCategories.length > 0 && sortedCategories[0][1] > thisMonthExpense * 0.4) {
        recommendations.push({ type: 'info', icon: 'ğŸ“Š', text: sortedCategories[0][0] + ' ì¹´í…Œê³ ë¦¬ ì§€ì¶œì´ 40%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.' });
      }
      if (investmentProfitRate < 0) {
        recommendations.push({ type: 'warning', icon: 'ğŸ“‰', text: 'íˆ¬ì ìˆ˜ìµë¥ ì´ ë§ˆì´ë„ˆìŠ¤ì…ë‹ˆë‹¤. í¬íŠ¸í´ë¦¬ì˜¤ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
      } else if (investmentProfitRate > 10) {
        recommendations.push({ type: 'success', icon: 'ğŸ“ˆ', text: 'íˆ¬ì ìˆ˜ìµë¥  +' + investmentProfitRate.toFixed(1) + '%! ì˜ í•˜ê³  ê³„ì‹­ë‹ˆë‹¤.' });
      }
      if (activeGoal && goalProgress < 50) {
        var monthsRemaining = activeGoal.label === 'ì˜¬í•´ ëª©í‘œ' ? (12 - now.getMonth()) : 
                              activeGoal.label === '3ë…„ ëª©í‘œ' ? 36 : 
                              activeGoal.label === '5ë…„ ëª©í‘œ' ? 60 : 84;
        var monthlyNeeded = (activeGoal.value - totalBankBalance) / monthsRemaining;
        recommendations.push({ type: 'info', icon: 'ğŸ¯', text: activeGoal.label + ' ë‹¬ì„±ì„ ìœ„í•´ ì›” ' + formatNumber(Math.round(monthlyNeeded)) + 'ì› ì €ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
      }

      // Build HTML
      var html = '<div class="space-y-4 animate-fade-in">' +
        '<button onclick="hideAIAnalysis()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mb-2 flex items-center justify-center gap-2 hover:bg-gray-300 transition">' +
          '<i data-lucide="arrow-left" class="w-4 h-4"></i> í†µê³„ë¡œ ëŒì•„ê°€ê¸°' +
        '</button>' +

        // Health Score
        '<div class="bg-gradient-to-r ' + healthColor + ' text-white p-5 rounded-xl shadow-lg">' +
          '<div class="flex items-center justify-between mb-3">' +
            '<h3 class="font-bold text-lg">ğŸ¤– AI ì¬ì • ê±´ê°•ë„</h3>' +
            '<span class="text-3xl">' + healthEmoji + '</span>' +
          '</div>' +
          '<div class="text-4xl font-bold mb-2">' + healthScore + 'ì </div>' +
          '<div class="bg-white bg-opacity-30 rounded-full h-4 mb-2">' +
            '<div class="bg-white h-4 rounded-full transition-all" style="width: ' + healthScore + '%"></div>' +
          '</div>' +
          '<div class="text-sm opacity-90">' + 
            (healthScore >= 80 ? 'ë§¤ìš° ê±´ê°•í•œ ì¬ì • ìƒíƒœì…ë‹ˆë‹¤!' : 
             healthScore >= 60 ? 'ì–‘í˜¸í•œ ì¬ì • ìƒíƒœì…ë‹ˆë‹¤.' : 
             healthScore >= 40 ? 'ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤.' : 'ì¬ì • ê´€ë¦¬ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.') +
          '</div>' +
        '</div>' +

        // Income Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’°</span> ìˆ˜ì… íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="bg-green-50 p-3 rounded-lg">' +
              '<div class="text-xs text-green-600">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>' +
              '<div class="font-bold text-green-700">' + formatNumber(thisMonthIncome) + 'ì›</div>' +
              '<div class="text-xs ' + (incomeChange >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (incomeChange >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(incomeChange).toFixed(1) + '% ì „ì›”ëŒ€ë¹„</div>' +
            '</div>' +
            '<div class="bg-blue-50 p-3 rounded-lg">' +
              '<div class="text-xs text-blue-600">3ê°œì›” í‰ê· </div>' +
              '<div class="font-bold text-blue-700">' + formatNumber(Math.round(threeMonthIncome)) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-sm text-gray-600 mb-2">ìˆ˜ì…ì› êµ¬ì„±</div>' +
          (sortedIncomeCategories.length > 0 ? sortedIncomeCategories.slice(0, 5).map(function(cat) {
            var pct = thisMonthIncome > 0 ? (cat[1] / thisMonthIncome * 100) : 0;
            return '<div class="flex items-center gap-2 mb-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + cat[0] + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-green-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-green-600 w-16 text-right">' + formatNumber(cat[1]) + 'ì›</div>' +
            '</div>';
          }).join('') : '<div class="text-gray-400 text-sm">ìˆ˜ì… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Expense Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’¸</span> ì§€ì¶œ íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="bg-red-50 p-3 rounded-lg">' +
              '<div class="text-xs text-red-600">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>' +
              '<div class="font-bold text-red-700">' + formatNumber(thisMonthExpense) + 'ì›</div>' +
              '<div class="text-xs ' + (expenseChange >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (expenseChange >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(expenseChange).toFixed(1) + '% ì „ì›”ëŒ€ë¹„</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-3 rounded-lg">' +
              '<div class="text-xs text-purple-600">3ê°œì›” í‰ê· </div>' +
              '<div class="font-bold text-purple-700">' + formatNumber(Math.round(threeMonthExpense)) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-2 mb-3">' +
            '<div class="bg-blue-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-blue-600">í•„ìš” ì§€ì¶œ</div>' +
              '<div class="font-bold text-sm text-blue-700">' + formatNumber(thisMonthNecessary) + 'ì›</div>' +
              '<div class="text-xs text-blue-500">' + (thisMonthExpense > 0 ? (thisMonthNecessary / thisMonthExpense * 100).toFixed(0) : 0) + '%</div>' +
            '</div>' +
            '<div class="bg-gray-100 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-gray-600">ë¶ˆí•„ìš” ì§€ì¶œ</div>' +
              '<div class="font-bold text-sm text-gray-700">' + formatNumber(thisMonthUnnecessary) + 'ì›</div>' +
              '<div class="text-xs text-gray-500">' + (thisMonthExpense > 0 ? (thisMonthUnnecessary / thisMonthExpense * 100).toFixed(0) : 0) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-sm text-gray-600 mb-2">ì§€ì¶œ TOP 5</div>' +
          (sortedCategories.length > 0 ? sortedCategories.slice(0, 5).map(function(cat) {
            var pct = thisMonthExpense > 0 ? (cat[1] / thisMonthExpense * 100) : 0;
            return '<div class="flex items-center gap-2 mb-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + cat[0] + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-red-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-red-600 w-16 text-right">' + formatNumber(cat[1]) + 'ì›</div>' +
            '</div>';
          }).join('') : '<div class="text-gray-400 text-sm">ì§€ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Bank Balance Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ¦</span> ì€í–‰ ì”ê³  ë¶„ì„</h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg mb-3">' +
            '<div class="flex justify-between items-center">' +
              '<div>' +
                '<div class="text-sm text-blue-600">ì´ ìì‚°</div>' +
                '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBankBalance) + 'ì›</div>' +
              '</div>' +
              '<div class="' + rankInfo.bgColor + ' px-3 py-2 rounded-lg">' +
                '<span class="text-lg">' + rankInfo.icon + '</span>' +
                '<span class="font-bold ' + rankInfo.color + ' ml-1">' + rankInfo.rank + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          (state.bankBalances.length > 0 ? '<div class="space-y-2">' + state.bankBalances.map(function(bank) {
            var pct = totalBankBalance > 0 ? (bank.balance / totalBankBalance * 100) : 0;
            return '<div class="flex items-center gap-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + bank.name + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-indigo-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-indigo-600 w-20 text-right">' + formatNumber(bank.balance) + 'ì›</div>' +
            '</div>';
          }).join('') + '</div>' : '<div class="text-gray-400 text-sm">ë“±ë¡ëœ ì€í–‰ì´ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Investment Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ“ˆ</span> íˆ¬ì íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-3 gap-2 mb-3">' +
            '<div class="bg-indigo-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-indigo-600">íˆ¬ì ì›ê¸ˆ</div>' +
              '<div class="font-bold text-sm text-indigo-700">' + formatNumber(totalInvested) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-purple-600">í‰ê°€ ê¸ˆì•¡</div>' +
              '<div class="font-bold text-sm text-purple-700">' + formatNumber(totalCurrentValue) + 'ì›</div>' +
            '</div>' +
            '<div class="' + (investmentProfit >= 0 ? 'bg-red-50' : 'bg-blue-50') + ' p-2 rounded-lg text-center">' +
              '<div class="text-xs ' + (investmentProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">ìˆ˜ìµ</div>' +
              '<div class="font-bold text-sm ' + (investmentProfit >= 0 ? 'text-red-700' : 'text-blue-700') + '">' + 
                (investmentProfit >= 0 ? '+' : '') + formatNumber(investmentProfit) + 'ì›</div>' +
              '<div class="text-xs ' + (investmentProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (investmentProfit >= 0 ? '+' : '') + investmentProfitRate.toFixed(1) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="bg-green-50 p-2 rounded-lg mb-3 text-center">' +
            '<div class="text-xs text-green-600">ì´ ë°°ë‹¹ê¸ˆ</div>' +
            '<div class="font-bold text-green-700">' + formatNumber(totalDividends) + 'ì›</div>' +
          '</div>' +
          (Object.keys(investmentByType).length > 0 ? '<div class="text-sm text-gray-600 mb-2">íˆ¬ì ìœ í˜•ë³„ ë¶„í¬</div>' +
            Object.entries(investmentByType).map(function(entry) {
              var type = entry[0];
              var data = entry[1];
              var profit = data.current - data.invested;
              var pct = totalCurrentValue > 0 ? (data.current / totalCurrentValue * 100) : 0;
              return '<div class="flex items-center gap-2 mb-2">' +
                '<div class="w-16 text-xs text-gray-700">' + type + '</div>' +
                '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                  '<div class="bg-purple-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
                '</div>' +
                '<div class="text-xs font-bold ' + (profit >= 0 ? 'text-red-600' : 'text-blue-600') + ' w-16 text-right">' + 
                  (profit >= 0 ? '+' : '') + formatNumber(profit) + 'ì›</div>' +
              '</div>';
            }).join('') : '<div class="text-gray-400 text-sm">íˆ¬ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Exchange Rate Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’±</span> í™˜ì „ ìˆ˜ìµ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="border rounded-lg p-3">' +
              '<div class="flex items-center gap-2 mb-2">' +
                '<span>ğŸ‡ºğŸ‡¸</span><span class="font-bold">USD ë‹¬ëŸ¬</span>' +
              '</div>' +
              '<div class="text-sm text-gray-600">ë³´ìœ : $' + usdHolding.toFixed(2) + '</div>' +
              '<div class="text-sm text-gray-600">ë§¤ë„: ' + usdSold.length + 'ê±´</div>' +
              '<div class="font-bold ' + (usdProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + 
                (usdProfit >= 0 ? '+' : '') + formatNumber(Math.round(usdProfit)) + 'ì›</div>' +
              '<div class="text-xs ' + (usdProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (usdProfit >= 0 ? '+' : '') + usdProfitRate.toFixed(2) + '%</div>' +
            '</div>' +
            '<div class="border rounded-lg p-3">' +
              '<div class="flex items-center gap-2 mb-2">' +
                '<span>ğŸ‡¯ğŸ‡µ</span><span class="font-bold">JPY ì—”í™”</span>' +
              '</div>' +
              '<div class="text-sm text-gray-600">ë³´ìœ : Â¥' + jpyHolding.toFixed(0) + '</div>' +
              '<div class="text-sm text-gray-600">ë§¤ë„: ' + jpySold.length + 'ê±´</div>' +
              '<div class="font-bold ' + (jpyProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + 
                (jpyProfit >= 0 ? '+' : '') + formatNumber(Math.round(jpyProfit)) + 'ì›</div>' +
              '<div class="text-xs ' + (jpyProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (jpyProfit >= 0 ? '+' : '') + jpyProfitRate.toFixed(2) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg text-center">' +
            '<div class="text-sm text-green-600">í™˜ì „ ì´ ìˆ˜ìµ</div>' +
            '<div class="text-xl font-bold ' + (usdProfit + jpyProfit >= 0 ? 'text-green-700' : 'text-red-700') + '">' + 
              (usdProfit + jpyProfit >= 0 ? '+' : '') + formatNumber(Math.round(usdProfit + jpyProfit)) + 'ì›</div>' +
          '</div>' +
        '</div>' +

        // Period Comparison
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ“…</span> ê¸°ê°„ë³„ ë¹„êµ</h3>' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead class="bg-gray-50">' +
                '<tr>' +
                  '<th class="p-2 text-left">ê¸°ê°„</th>' +
                  '<th class="p-2 text-right">ìˆ˜ì…</th>' +
                  '<th class="p-2 text-right">ì§€ì¶œ</th>' +
                  '<th class="p-2 text-right">ì €ì¶•ë¥ </th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">ì´ë²ˆ ë‹¬</td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(thisMonthIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(thisMonthExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + savingsRate.toFixed(1) + '%</td>' +
                '</tr>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">ì§€ë‚œ ë‹¬</td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(lastMonthIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(lastMonthExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + lastSavingsRate.toFixed(1) + '%</td>' +
                '</tr>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">3ê°œì›” í‰ê· </td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(Math.round(threeMonthIncome)) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(Math.round(threeMonthExpense)) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + (threeMonthIncome > 0 ? ((threeMonthIncome - threeMonthExpense) / threeMonthIncome * 100).toFixed(1) : 0) + '%</td>' +
                '</tr>' +
                '<tr>' +
                  '<td class="p-2 font-medium">ì˜¬í•´ ëˆ„ì </td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(yearIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(yearExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + (yearIncome > 0 ? ((yearIncome - yearExpense) / yearIncome * 100).toFixed(1) : 0) + '%</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +

        // AI Recommendations
        '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’¡</span> AI ê¶Œì¥ì‚¬í•­</h3>' +
          '<div class="space-y-2">' +
            recommendations.map(function(rec) {
              var bgColor = rec.type === 'success' ? 'bg-green-100 border-green-300' : 
                           rec.type === 'warning' ? 'bg-yellow-100 border-yellow-300' : 'bg-blue-100 border-blue-300';
              return '<div class="p-3 rounded-lg border ' + bgColor + '">' +
                '<span class="mr-2">' + rec.icon + '</span>' +
                '<span class="text-sm">' + rec.text + '</span>' +
              '</div>';
            }).join('') +
          '</div>' +
        '</div>' +

      '</div>';

      aiContent.innerHTML = html;
      lucide.createIcons();
    }

    function hideAIAnalysis() {
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      if (statsContent) statsContent.classList.remove('hidden');
      if (aiContent) aiContent.classList.add('hidden');
    }

    function generateAIAnalysis() {
      var aiContent = document.getElementById('ai-analysis-content');
      if (!aiContent) return;

      var now = new Date();
      var thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      var lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);

      var thisMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= thisMonthStart; });
      var lastMonthTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d >= lastMonthStart && d <= lastMonthEnd;
      });

      var thisMonthIncome = thisMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthExpense = thisMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthIncome = lastMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthExpense = lastMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      var savingsRate = thisMonthIncome > 0 ? ((thisMonthIncome - thisMonthExpense) / thisMonthIncome * 100).toFixed(1) : 0;
      var expenseChange = lastMonthExpense > 0 ? ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100).toFixed(1) : 0;

      var healthScore = 100;
      if (savingsRate < 20) healthScore -= 20;
      if (savingsRate < 10) healthScore -= 20;
      if (savingsRate < 0) healthScore -= 30;
      if (expenseChange > 20) healthScore -= 20;

      aiContent.innerHTML = '<div class="space-y-4 animate-fade-in">' +
        '<button onclick="showAIAnalysis()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mb-2 flex items-center justify-center gap-2 hover:bg-gray-300 transition">' +
          '<i data-lucide="arrow-left" class="w-4 h-4"></i> í†µê³„ë¡œ ëŒì•„ê°€ê¸°' +
        '</button>' +
        '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-5 rounded-xl shadow-lg">' +
          '<h3 class="font-bold text-lg mb-3">ğŸ¤– AI ì¬ì • ê±´ê°•ë„: ' + healthScore + 'ì </h3>' +
          '<div class="bg-white bg-opacity-20 rounded-full h-4 mb-2">' +
            '<div class="bg-white h-4 rounded-full" style="width: ' + healthScore + '%"></div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3">ğŸ“Š ì´ë²ˆ ë‹¬ ìš”ì•½</h3>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div class="bg-green-50 p-3 rounded-lg">' +
              '<div class="text-xs text-green-600">ìˆ˜ì…</div>' +
              '<div class="font-bold text-green-700">' + formatNumber(thisMonthIncome) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-red-50 p-3 rounded-lg">' +
              '<div class="text-xs text-red-600">ì§€ì¶œ</div>' +
              '<div class="font-bold text-red-700">' + formatNumber(thisMonthExpense) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-blue-50 p-3 rounded-lg">' +
              '<div class="text-xs text-blue-600">ì €ì¶•ë¥ </div>' +
              '<div class="font-bold text-blue-700">' + savingsRate + '%</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-3 rounded-lg">' +
              '<div class="text-xs text-purple-600">ì§€ì¶œë³€í™”</div>' +
              '<div class="font-bold ' + (expenseChange > 0 ? 'text-red-700' : 'text-green-700') + '">' + (expenseChange > 0 ? '+' : '') + expenseChange + '%</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3">ğŸ’¡ AI ê¶Œì¥ì‚¬í•­</h3>' +
          '<div class="space-y-2">' +
            (savingsRate < 20 ? '<div class="p-2 bg-yellow-50 rounded-lg text-sm text-yellow-700">âš ï¸ ì €ì¶•ë¥ ì„ 20% ì´ìƒìœ¼ë¡œ ë†’ì´ì„¸ìš”</div>' : '<div class="p-2 bg-green-50 rounded-lg text-sm text-green-700">âœ… ì €ì¶•ë¥ ì´ ì–‘í˜¸í•©ë‹ˆë‹¤</div>') +
            (expenseChange > 10 ? '<div class="p-2 bg-red-50 rounded-lg text-sm text-red-700">ğŸš¨ ì§€ì¶œì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤</div>' : '') +
          '</div>' +
        '</div>' +
      '</div>';

      lucide.createIcons();
    }

    // Goal Screen
    function renderGoalScreen() {
      var totalBank = state.bankBalances.reduce(function(s, b) { return s + b.balance; }, 0);
      
      var bankListHtml = state.bankBalances.map(function(b) {
        return '<div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">' +
          '<div><div class="font-medium">' + b.name + '</div><div class="text-sm text-gray-600">' + formatNumber(b.balance) + 'ì›</div></div>' +
          '<button onclick="deleteBank(' + b.id + ')" class="text-red-500 text-sm px-2 py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>' +
        '</div>';
      }).join('');

      // Calculate goal achievements
      var goals = [
        { label: '7ë…„ ëª©í‘œ', value: Number(state.goals.year7) || 0, icon: 'ğŸ‘‘', color: 'purple' },
        { label: '5ë…„ ëª©í‘œ', value: Number(state.goals.year5) || 0, icon: 'ğŸ’', color: 'blue' },
        { label: '3ë…„ ëª©í‘œ', value: Number(state.goals.year3) || 0, icon: 'ğŸ†', color: 'green' },
        { label: 'ì˜¬í•´ ëª©í‘œ', value: Number(state.goals.thisYear) || 0, icon: 'â­', color: 'yellow' }
      ];

      var goalAchievementHtml = goals.map(function(goal) {
        if (goal.value === 0) return '';
        var percentage = Math.min((totalBank / goal.value) * 100, 100);
        var remaining = Math.max(goal.value - totalBank, 0);
        var isAchieved = totalBank >= goal.value;
        
        var barColor = goal.color === 'purple' ? 'from-purple-400 to-purple-600' :
                       goal.color === 'blue' ? 'from-blue-400 to-blue-600' :
                       goal.color === 'green' ? 'from-green-400 to-green-600' :
                       'from-yellow-400 to-yellow-600';
        
        var textColor = goal.color === 'purple' ? 'text-purple-700' :
                        goal.color === 'blue' ? 'text-blue-700' :
                        goal.color === 'green' ? 'text-green-700' :
                        'text-yellow-700';
        
        var bgColor = goal.color === 'purple' ? 'bg-purple-50 border-purple-200' :
                      goal.color === 'blue' ? 'bg-blue-50 border-blue-200' :
                      goal.color === 'green' ? 'bg-green-50 border-green-200' :
                      'bg-yellow-50 border-yellow-200';

        return '<div class="p-4 rounded-xl border ' + bgColor + ' mb-3">' +
          '<div class="flex justify-between items-center mb-2">' +
            '<div class="flex items-center gap-2">' +
              '<span class="text-xl">' + goal.icon + '</span>' +
              '<span class="font-bold ' + textColor + '">' + goal.label + '</span>' +
            '</div>' +
            '<div class="text-right">' +
              '<div class="text-sm text-gray-600">' + formatNumber(totalBank) + ' / ' + formatNumber(goal.value) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="relative w-full bg-gray-200 rounded-full h-8 overflow-hidden">' +
            '<div class="absolute inset-0 bg-gradient-to-r ' + barColor + ' h-8 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ' + percentage + '%">' +
              (percentage > 15 ? '<span class="text-white font-bold text-sm drop-shadow">' + percentage.toFixed(1) + '%</span>' : '') +
            '</div>' +
            (percentage <= 15 ? '<span class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600 font-bold text-sm">' + percentage.toFixed(1) + '%</span>' : '') +
          '</div>' +
          '<div class="flex justify-between items-center mt-2 text-sm">' +
            (isAchieved ? 
              '<span class="text-green-600 font-bold">ğŸ‰ ëª©í‘œ ë‹¬ì„±!</span><span></span>' :
              '<span class="text-gray-600">ë‹¬ì„±ë¥ : ' + percentage.toFixed(1) + '%</span>' +
              '<span class="text-red-600 font-medium">ë‚¨ì€ ê¸ˆì•¡: ' + formatNumber(remaining) + 'ì›</span>') +
          '</div>' +
        '</div>';
      }).join('');

      // Bank distribution chart
      var maxBankBalance = Math.max.apply(null, state.bankBalances.map(function(b) { return b.balance; }).concat([1]));
      var bankChartHtml = state.bankBalances.length > 0 ? state.bankBalances.map(function(b, index) {
        var percentage = (b.balance / totalBank) * 100;
        var barWidth = (b.balance / maxBankBalance) * 100;
        var colors = ['from-blue-400 to-blue-600', 'from-green-400 to-green-600', 'from-purple-400 to-purple-600', 'from-orange-400 to-orange-600', 'from-pink-400 to-pink-600', 'from-teal-400 to-teal-600'];
        var color = colors[index % colors.length];
        
        return '<div class="mb-3">' +
          '<div class="flex justify-between items-center mb-1">' +
            '<span class="text-sm font-medium text-gray-700">' + b.name + '</span>' +
            '<span class="text-sm text-gray-600">' + formatNumber(b.balance) + 'ì› (' + percentage.toFixed(1) + '%)</span>' +
          '</div>' +
          '<div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">' +
            '<div class="bg-gradient-to-r ' + color + ' h-6 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ' + barWidth + '%">' +
              (barWidth > 20 ? '<span class="text-white text-xs font-bold">' + percentage.toFixed(0) + '%</span>' : '') +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ ì€í–‰ì´ ì—†ìŠµë‹ˆë‹¤</div>';

      return '<div class="p-4 space-y-6">' +
        // Goal Achievement Status
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“Š ëª©í‘œ ë‹¬ì„± í˜„í™©</h3>' +
          '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl mb-4">' +
            '<div class="text-sm opacity-90">í˜„ì¬ ì´ ìì‚°</div>' +
            '<div class="text-3xl font-bold">' + formatNumber(totalBank) + 'ì›</div>' +
          '</div>' +
          (goalAchievementHtml || '<div class="text-center text-gray-400 py-4">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>') +
        '</div>' +
        // Bank Distribution Chart
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“ˆ ì€í–‰ë³„ ìì‚° ë¶„í¬</h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl mb-4">' +
            '<div class="text-sm text-blue-600 font-medium">ì´ ìì‚°</div>' +
            '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBank) + 'ì›</div>' +
            '<div class="text-xs text-gray-500 mt-1">' + state.bankBalances.length + 'ê°œ ì€í–‰</div>' +
          '</div>' +
          bankChartHtml +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4">ğŸ¯ ìˆ˜ì… ëª©í‘œ</h3>' +
          '<div class="space-y-3">' +
            '<div><label class="block text-sm font-medium mb-1 text-purple-700">ğŸ‘‘ 7ë…„ ëª©í‘œ</label>' +
              '<input type="number" id="goal-year7" value="' + state.goals.year7 + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-blue-700">ğŸ’ 5ë…„ ëª©í‘œ</label>' +
              '<input type="number" id="goal-year5" value="' + state.goals.year5 + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-green-700">ğŸ† 3ë…„ ëª©í‘œ</label>' +
              '<input type="number" id="goal-year3" value="' + state.goals.year3 + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-yellow-700">â­ ì˜¬í•´ ëª©í‘œ</label>' +
              '<input type="number" id="goal-thisYear" value="' + state.goals.thisYear + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>' +
            '<button onclick="saveGoals()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium">ëª©í‘œ ì €ì¥</button>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4">ì€í–‰ë³„ í†µí•©ì”ê³ </h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">' +
            '<div class="text-sm text-blue-600">ì´ ì”ê³ </div>' +
            '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBank) + 'ì›</div>' +
          '</div>' +
          '<div class="space-y-2 mb-4">' + bankListHtml + '</div>' +
          '<div class="space-y-2">' +
            '<input type="text" id="newBankName" class="w-full p-2 border rounded-lg" placeholder="ì€í–‰ëª…">' +
            '<input type="number" id="newBankBalance" class="w-full p-2 border rounded-lg" placeholder="ì”ê³ ">' +
            '<button onclick="addBank()" class="w-full bg-green-500 text-white py-2 rounded-lg">ì€í–‰ ì¶”ê°€</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function saveGoals() {
      state.goals = {
        year7: document.getElementById('goal-year7') ? document.getElementById('goal-year7').value : '',
        year5: document.getElementById('goal-year5') ? document.getElementById('goal-year5').value : '',
        year3: document.getElementById('goal-year3') ? document.getElementById('goal-year3').value : '',
        thisYear: document.getElementById('goal-thisYear') ? document.getElementById('goal-thisYear').value : ''
      };
      saveData();
      showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function addBank() {
      var name = document.getElementById('newBankName') ? document.getElementById('newBankName').value : '';
      var balance = Number(document.getElementById('newBankBalance') ? document.getElementById('newBankBalance').value : 0);
      if (!name || isNaN(balance)) { alert('ì€í–‰ëª…ê³¼ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.bankBalances.push({ id: Date.now(), name: name, balance: balance });
      saveData();
      render();
      showToast('ì€í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteBank(id) {
      if (confirm('ì€í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.bankBalances = state.bankBalances.filter(function(b) { return b.id !== id; });
        saveData();
        render();
        showToast('ì€í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Investment Screen
    var investmentSearchKeyword = '';
    
    function updateInvestmentSearch(keyword) {
      investmentSearchKeyword = keyword;
      render();
      // Restore focus and cursor position
      setTimeout(function() {
        var input = document.getElementById('investmentSearch');
        if (input) {
          input.focus();
          input.setSelectionRange(keyword.length, keyword.length);
        }
      }, 0);
    }
    
    function setDividendPeriod(period) {
      state.dividendPeriod = period;
      render();
    }
    
    function updateDividendSearch(keyword) {
      state.dividendSearchKeyword = keyword;
      render();
      // Restore focus and cursor position
      setTimeout(function() {
        var input = document.getElementById('dividendSearch');
        if (input) {
          input.focus();
          input.setSelectionRange(keyword.length, keyword.length);
        }
      }, 0);
    }
    
    function renderInvestmentScreen() {
      var totalInvested = state.investments.reduce(function(s, i) { return s + i.buyPrice * i.quantity; }, 0);
      var totalCurrentValue = state.investments.reduce(function(s, i) { return s + i.currentPrice * i.quantity; }, 0);
      var totalProfit = totalCurrentValue - totalInvested;
      var totalDividends = state.dividends.reduce(function(s, d) { return s + d.amount; }, 0);

      var typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
      var typeIcons = { stock: 'ğŸ“Š', etf: 'ğŸ“¦', fund: 'ğŸ’¼', crypto: 'ğŸª™', gold: 'ğŸ¥‡', realestate: 'ğŸ ', bond: 'ğŸ“ƒ', other: 'ğŸ“„' };

      // Filter investments by search keyword
      var filteredInvestments = state.investments.filter(function(inv) {
        if (!investmentSearchKeyword) return true;
        var keyword = investmentSearchKeyword.toLowerCase();
        var name = inv.name.toLowerCase();
        var typeLabel = (typeLabels[inv.type] || 'ê¸°íƒ€').toLowerCase();
        return name.indexOf(keyword) >= 0 || typeLabel.indexOf(keyword) >= 0;
      });

      var investListHtml = '';
      if (state.investments.length === 0) {
        investListHtml = '<div class="text-center text-gray-400 py-8">ë“±ë¡ëœ íˆ¬ì ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else if (filteredInvestments.length === 0) {
        investListHtml = '<div class="text-center text-gray-400 py-8">"' + investmentSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        investListHtml = filteredInvestments.map(function(inv) {
          var invested = inv.buyPrice * inv.quantity;
          var current = inv.currentPrice * inv.quantity;
          var profit = current - invested;
          var profitRate = invested > 0 ? ((profit / invested) * 100).toFixed(2) : 0;
          var icon = typeIcons[inv.type] || 'ğŸ“„';
          var label = typeLabels[inv.type] || 'ê¸°íƒ€';
          
          return '<div class="border rounded-lg p-4 bg-gray-50">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<div>' +
                '<div class="flex items-center gap-2">' +
                  '<span class="text-lg">' + icon + '</span>' +
                  '<span class="font-bold">' + inv.name + '</span>' +
                  '<span class="text-xs bg-gray-200 px-2 py-0.5 rounded">' + label + '</span>' +
                '</div>' +
                '<div class="text-sm text-gray-500 mt-1">' + inv.quantity + 'ì£¼ ë³´ìœ </div>' +
              '</div>' +
              '<div class="text-right">' +
                '<div class="font-bold ' + (profit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (profit >= 0 ? '+' : '') + formatNumber(profit) + 'ì›</div>' +
                '<div class="text-sm ' + (profit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + (profit >= 0 ? '+' : '') + profitRate + '%</div>' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 text-sm mb-3">' +
              '<div class="bg-white p-2 rounded"><div class="text-xs text-gray-500">ë§¤ì…ê°€</div><div class="font-medium">' + formatNumber(inv.buyPrice) + 'ì›</div></div>' +
              '<div class="bg-white p-2 rounded"><div class="text-xs text-gray-500">í˜„ì¬ê°€</div><div class="font-medium">' + formatNumber(inv.currentPrice) + 'ì›</div></div>' +
            '</div>' +
            '<div class="flex gap-2 mt-3 pt-3 border-t">' +
              '<button onclick="editInvestmentPrice(' + inv.id + ')" class="flex-1 text-blue-500 text-sm py-1 hover:bg-blue-50 rounded">í˜„ì¬ê°€ ìˆ˜ì •</button>' +
              '<button onclick="deleteInvestment(' + inv.id + ')" class="flex-1 text-red-500 text-sm py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>' +
            '</div>' +
          '</div>';
        }).join('');
      }

      // Dividend filtering and grouping
      var dividendSearchKeyword = state.dividendSearchKeyword || '';
      var dividendPeriod = state.dividendPeriod || 'all';
      
      var filteredDividends = state.dividends.filter(function(d) {
        if (!dividendSearchKeyword) return true;
        return d.stockName.toLowerCase().indexOf(dividendSearchKeyword.toLowerCase()) >= 0;
      });
      
      // Group dividends by period
      var groupedDividends = {};
      filteredDividends.forEach(function(d) {
        var date = new Date(d.date);
        var key;
        if (dividendPeriod === 'weekly') {
          var weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0] + ' ì£¼';
        } else if (dividendPeriod === 'monthly') {
          key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        } else if (dividendPeriod === 'yearly') {
          key = date.getFullYear() + 'ë…„';
        } else {
          key = 'all';
        }
        if (!groupedDividends[key]) groupedDividends[key] = [];
        groupedDividends[key].push(d);
      });
      
      var dividendListHtml = '';
      if (state.dividends.length === 0) {
        dividendListHtml = '<div class="text-center text-gray-400 py-4">ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else if (filteredDividends.length === 0) {
        dividendListHtml = '<div class="text-center text-gray-400 py-4">"' + dividendSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        if (dividendPeriod === 'all') {
          var sortedDividends = filteredDividends.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
          dividendListHtml = '<table class="w-full text-sm">' +
            '<thead class="bg-gray-50">' +
              '<tr>' +
                '<th class="text-left py-2 px-2 font-medium text-gray-600">ì¢…ëª©ëª…</th>' +
                '<th class="text-left py-2 px-2 font-medium text-gray-600">ë‚ ì§œ</th>' +
                '<th class="text-right py-2 px-2 font-medium text-gray-600">ë°°ë‹¹ê¸ˆ</th>' +
                '<th class="text-center py-2 px-1 font-medium text-gray-600"></th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
            sortedDividends.map(function(d) {
              return '<tr class="border-b last:border-b-0">' +
                '<td class="py-2 px-2 font-medium">' + d.stockName + '</td>' +
                '<td class="py-2 px-2 text-gray-500">' + d.date + '</td>' +
                '<td class="py-2 px-2 text-right font-bold text-green-600">+' + formatNumber(d.amount) + 'ì›</td>' +
                '<td class="py-2 px-1 text-center"><button onclick="deleteDividend(' + d.id + ')" class="text-red-400 hover:text-red-600 text-xs">ì‚­ì œ</button></td>' +
              '</tr>';
            }).join('') +
            '</tbody>' +
          '</table>';
        } else {
          dividendListHtml = Object.keys(groupedDividends).sort().reverse().map(function(period) {
            var periodDividends = groupedDividends[period];
            var periodTotal = periodDividends.reduce(function(s, d) { return s + d.amount; }, 0);
            
            return '<div class="mb-4 border rounded-lg overflow-hidden">' +
              '<div class="bg-green-50 px-3 py-2 flex justify-between items-center">' +
                '<span class="font-bold text-green-800">' + period + '</span>' +
                '<span class="font-bold text-green-600">+' + formatNumber(periodTotal) + 'ì›</span>' +
              '</div>' +
              '<table class="w-full text-sm">' +
                '<tbody>' +
                periodDividends.sort(function(a, b) { return new Date(b.date) - new Date(a.date); }).map(function(d) {
                  return '<tr class="border-b last:border-b-0">' +
                    '<td class="py-2 px-3 font-medium">' + d.stockName + '</td>' +
                    '<td class="py-2 px-2 text-gray-500 text-xs">' + d.date + '</td>' +
                    '<td class="py-2 px-2 text-right font-bold text-green-600">+' + formatNumber(d.amount) + 'ì›</td>' +
                    '<td class="py-2 px-1 text-center"><button onclick="deleteDividend(' + d.id + ')" class="text-red-400 hover:text-red-600 text-xs">ì‚­ì œ</button></td>' +
                  '</tr>';
                }).join('') +
                '</tbody>' +
              '</table>' +
            '</div>';
          }).join('');
        }
      }

      // Journal list
      var journalListHtml = '';
      if (state.investmentJournals.length === 0) {
        journalListHtml = '<div class="text-center text-gray-400 py-4">íˆ¬ìì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        var sortedJournals = state.investmentJournals.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
        journalListHtml = sortedJournals.slice(0, 5).map(function(j) {
          return '<div class="border rounded-lg p-3 bg-yellow-50">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<div class="text-sm text-gray-600">' + j.date + '</div>' +
              '<button onclick="deleteJournal(' + j.id + ')" class="text-red-400 text-xs">ì‚­ì œ</button>' +
            '</div>' +
            '<div class="text-gray-800 text-sm whitespace-pre-wrap">' + j.content + '</div>' +
          '</div>';
        }).join('');
      }

      return '<div class="p-4 space-y-6">' +
        '<div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-6 rounded-xl shadow-lg">' +
          '<div class="text-sm font-medium mb-1">ğŸ“Š ì´ íˆ¬ì í˜„í™©</div>' +
          '<div class="text-3xl font-bold mb-2">' + formatNumber(totalCurrentValue) + 'ì›</div>' +
          '<div class="grid grid-cols-3 gap-3 mt-4">' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">íˆ¬ì ì›ê¸ˆ</div><div class="font-bold text-sm text-indigo-700">' + formatNumber(totalInvested) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">í‰ê°€ ì†ìµ</div>' +
              '<div class="font-bold text-sm ' + (totalProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (totalProfit >= 0 ? '+' : '') + formatNumber(totalProfit) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">ì´ ë°°ë‹¹ê¸ˆ</div>' +
              '<div class="font-bold text-sm text-green-600">' + formatNumber(totalDividends) + 'ì›</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h3 class="font-bold">ğŸ“ˆ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>' +
            '<button onclick="state.showAddInvestment=true;render()" class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm">+ ì¢…ëª© ì¶”ê°€</button>' +
          '</div>' +
          '<div class="mb-3">' +
            '<div class="relative">' +
              '<input type="text" id="investmentSearch" value="' + investmentSearchKeyword + '" oninput="updateInvestmentSearch(this.value)" class="w-full p-2 pl-9 border rounded-lg text-sm" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ìœ í˜•ìœ¼ë¡œ ê²€ìƒ‰...">' +
              '<i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-gray-400"></i>' +
            '</div>' +
            (state.investments.length > 0 ? '<div class="text-xs text-gray-500 mt-1">ì´ ' + state.investments.length + 'ê°œ ì¢…ëª© ì¤‘ ' + filteredInvestments.length + 'ê°œ í‘œì‹œ</div>' : '') +
          '</div>' +
          '<div class="space-y-3">' + investListHtml + '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h3 class="font-bold">ğŸ’° ë°°ë‹¹ ë‚´ì—­</h3>' +
            '<div class="flex items-center gap-2">' +
              '<div class="bg-green-100 px-3 py-1 rounded-lg">' +
                '<span class="text-xs text-green-600">ì´ ë°°ë‹¹: </span>' +
                '<span class="font-bold text-green-700">' + formatNumber(totalDividends) + 'ì›</span>' +
              '</div>' +
              '<button onclick="state.showAddDividend=true;render()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-medium">+ ë°°ë‹¹ì¶”ê°€</button>' +
            '</div>' +
          '</div>' +
          '<div class="mb-3">' +
            '<div class="flex gap-1 mb-2 overflow-x-auto pb-1">' +
              '<button onclick="setDividendPeriod(\'all\')" class="px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ' + (dividendPeriod === 'all' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì „ì²´</button>' +
              '<button onclick="setDividendPeriod(\'weekly\')" class="px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ' + (dividendPeriod === 'weekly' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì£¼ë³„</button>' +
              '<button onclick="setDividendPeriod(\'monthly\')" class="px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ' + (dividendPeriod === 'monthly' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì›”ë³„</button>' +
              '<button onclick="setDividendPeriod(\'yearly\')" class="px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ' + (dividendPeriod === 'yearly' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700') + '">ë…„ë„ë³„</button>' +
            '</div>' +
            '<div class="relative">' +
              '<input type="text" id="dividendSearch" value="' + dividendSearchKeyword + '" oninput="updateDividendSearch(this.value)" class="w-full p-2 pl-9 border rounded-lg text-sm" placeholder="ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰...">' +
              '<i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-gray-400"></i>' +
            '</div>' +
            (state.dividends.length > 0 ? '<div class="text-xs text-gray-500 mt-1">ì´ ' + state.dividends.length + 'ê±´ ì¤‘ ' + filteredDividends.length + 'ê±´ í‘œì‹œ</div>' : '') +
          '</div>' +
          '<div class="overflow-x-auto max-h-80 overflow-y-auto">' + dividendListHtml + '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-4">' +
            '<h3 class="font-bold">ğŸ“ íˆ¬ì ì¼ì§€</h3>' +
            '<button onclick="state.showAddJournal=true;render()" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm">+ ì¼ì§€ ì‘ì„±</button>' +
          '</div>' +
          '<div class="space-y-3">' + journalListHtml + '</div>' +
        '</div>' +
      '</div>';
    }

    function addInvestment() {
      var name = document.getElementById('invName') ? document.getElementById('invName').value : '';
      var type = document.getElementById('invType') ? document.getElementById('invType').value : 'stock';
      var quantity = Number(document.getElementById('invQuantity') ? document.getElementById('invQuantity').value : 0);
      var buyPrice = Number(document.getElementById('invBuyPrice') ? document.getElementById('invBuyPrice').value : 0);
      var currentPrice = Number(document.getElementById('invCurrentPrice') ? document.getElementById('invCurrentPrice').value : 0) || buyPrice;

      if (!name || !quantity || !buyPrice) {
        alert('ì¢…ëª©ëª…, ìˆ˜ëŸ‰, ë§¤ì…ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.investments.push({ id: Date.now(), name: name, type: type, quantity: quantity, buyPrice: buyPrice, currentPrice: currentPrice });
      state.showAddInvestment = false;
      saveData();
      render();
      showToast('íˆ¬ì ì¢…ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editInvestmentPrice(id) {
      var inv = state.investments.find(function(i) { return i.id === id; });
      if (!inv) return;
      var newPrice = prompt('í˜„ì¬ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', inv.currentPrice);
      if (newPrice === null) return;
      inv.currentPrice = Number(newPrice) || inv.currentPrice;
      saveData();
      render();
      showToast('í˜„ì¬ê°€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteInvestment(id) {
      if (confirm('ì´ íˆ¬ì ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.investments = state.investments.filter(function(i) { return i.id !== id; });
        saveData();
        render();
        showToast('íˆ¬ì ì¢…ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Dividend functions
    function addDividend() {
      var stockNameEl = document.getElementById('divStockName');
      var amountEl = document.getElementById('divAmount');
      var dateEl = document.getElementById('divDate');
      
      var stockName = stockNameEl ? stockNameEl.value.trim() : '';
      var amount = Number(amountEl ? amountEl.value : 0);
      var date = dateEl ? dateEl.value : '';

      if (!stockName) {
        alert('ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!amount || amount <= 0) {
        alert('ë°°ë‹¹ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!date) {
        alert('ë°°ë‹¹ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }

      state.dividends.push({
        id: Date.now(),
        stockName: stockName,
        amount: amount,
        date: date
      });

      state.showAddDividend = false;
      saveData();
      render();
      showToast('ë°°ë‹¹ ë‚´ì—­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteDividend(id) {
      if (confirm('ë°°ë‹¹ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.dividends = state.dividends.filter(function(d) { return d.id !== id; });
        saveData();
        render();
        showToast('ë°°ë‹¹ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Investment Journal functions
    function addJournal() {
      var content = document.getElementById('journalContent') ? document.getElementById('journalContent').value : '';
      var date = document.getElementById('journalDate') ? document.getElementById('journalDate').value : '';

      if (!content || !date) {
        alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.investmentJournals.push({
        id: Date.now(),
        date: date,
        content: content
      });

      state.showAddJournal = false;
      saveData();
      render();
      showToast('íˆ¬ìì¼ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteJournal(id) {
      if (confirm('íˆ¬ìì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.investmentJournals = state.investmentJournals.filter(function(j) { return j.id !== id; });
        saveData();
        render();
        showToast('íˆ¬ìì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Exchange Screen
    function renderExchangeScreen() {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var sym = state.exchangeTab === 'USD' ? '$' : 'Â¥';

      // Calculate totals
      var totalUsd = state.usdPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var totalJpy = state.jpyPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var foreign = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var avgRate = foreign > 0 ? (invested / foreign).toFixed(2) : 0;
      var unrealized = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + ((p.amount / p.buyRate) * currentRate - p.amount); }, 0);
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var cumInvested = state.usdPhases.concat(state.jpyPhases).reduce(function(s, p) { return s + p.amount; }, 0);
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var currentBudget = initialBudget + profit;
      var pendingAmount = phases.filter(function(p) { return !p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalNeeded = invested + pendingAmount;
      var canAddMore = totalNeeded < currentBudget;

      // Calculate grade
      var allSold = state.usdPhases.concat(state.jpyPhases).filter(function(p) { return p.sold; });
      var totalSoldInv = allSold.reduce(function(s, p) { return s + p.amount; }, 0);
      var totalSoldProf = allSold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var gradeInfo = getInvestGrade(totalSoldProf, totalSoldInv);

      var active = phases.filter(function(p) { return !p.sold; });
      var sold = phases.filter(function(p) { return p.sold; });

      var activeHtml = active.map(function(p, i) {
        var f = p.amount / p.buyRate;
        var cp = (f * currentRate) - p.amount;
        var isExpanded = state.expandedPhase === p.id;
        
        return '<div class="bg-white rounded-xl shadow-md">' +
          '<div onclick="toggleExpandPhase(' + p.id + ')" class="p-4 cursor-pointer ' + (p.completed ? 'bg-green-50' : 'bg-blue-50') + ' rounded-t-xl">' +
            '<div class="flex justify-between items-start">' +
              '<div class="flex-1">' +
                '<p class="font-bold text-gray-800">' + (i + 1) + 'ì°¨ ë§¤ìˆ˜</p>' +
                '<p class="text-xs text-gray-600 mt-0.5">' + (p.completed ? 'ë§¤ìˆ˜ì¼: ' + p.date : 'ë§¤ìˆ˜ëŒ€ê¸°') + '</p>' +
                (p.completed ? '<p class="text-xs font-bold mt-2 ' + (cp >= 0 ? 'text-red-600' : 'text-blue-600') + '">í˜„ì¬: ' + (cp >= 0 ? '+' : '') + (cp / 10000).toFixed(1) + 'ë§Œì›</p>' : '') +
              '</div>' +
              '<i data-lucide="' + (isExpanded ? 'chevron-up' : 'chevron-down') + '" class="w-5 h-5"></i>' +
            '</div>' +
          '</div>' +
          (isExpanded ? '<div class="p-4 space-y-3">' +
            '<div><label class="text-xs text-gray-600 block mb-1">íˆ¬ìê¸ˆì•¡</label><input type="number" id="phase-amount-' + p.id + '" value="' + p.amount + '" class="w-full px-3 py-2 border rounded" ' + (p.completed ? 'disabled' : '') + '></div>' +
            '<div><label class="text-xs text-gray-600 block mb-1">ë§¤ìˆ˜í™˜ìœ¨</label><input type="number" id="phase-buyRate-' + p.id + '" value="' + p.buyRate + '" class="w-full px-3 py-2 border rounded" ' + (p.completed ? 'disabled' : '') + ' step="0.01"></div>' +
            '<div><label class="text-xs text-gray-600 block mb-1">ëª©í‘œ ë§¤ë„í™˜ìœ¨</label><input type="number" id="phase-sellRate-' + p.id + '" value="' + p.sellRate + '" class="w-full px-3 py-2 border rounded" step="0.01"></div>' +
            '<div class="bg-gray-50 rounded p-3 text-sm"><p>ğŸ’µ ' + sym + (state.exchangeTab === 'USD' ? f.toFixed(2) : f.toFixed(0)) + '</p><p>ğŸ“ˆ ì§€ê¸ˆ ë§¤ë„ì‹œ: ' + (cp >= 0 ? '+' : '') + cp.toLocaleString() + 'ì›</p></div>' +
            '<div class="flex gap-2">' +
              (!p.completed ? '<button onclick="completeExchangePhase(' + p.id + ')" class="flex-1 bg-green-500 text-white py-2 rounded font-bold">ë§¤ìˆ˜ì™„ë£Œ</button>' : '') +
              (p.completed ? '<button onclick="sellExchangePhase(' + p.id + ')" class="flex-1 bg-purple-500 text-white py-2 rounded font-bold">ë§¤ë„</button>' : '') +
              '<button onclick="saveExchangePhase(' + p.id + ')" class="px-4 bg-blue-500 text-white rounded">ì €ì¥</button>' +
              '<button onclick="deleteExchangePhase(' + p.id + ')" class="px-4 bg-red-500 text-white rounded">ì‚­ì œ</button>' +
            '</div>' +
          '</div>' : '') +
        '</div>';
      }).join('');

      var soldHtml = '';
      if (sold.length > 0) {
        var visibleSold = sold.slice(0, state.soldItemsVisible);
        soldHtml = '<div class="mt-4">' +
          '<h3 class="font-bold text-gray-700 mb-3 text-sm">âœ… ë§¤ë„ ì™„ë£Œ (' + sold.length + 'ê±´)</h3>' +
          visibleSold.map(function(p) {
            var f = p.amount / p.buyRate;
            var pr = (f * p.sellRate) - p.amount;
            var isExpanded = state.expandedPhase === p.id;
            
            return '<div class="bg-white rounded-xl shadow-md mb-3 opacity-70">' +
              '<div onclick="toggleExpandPhase(' + p.id + ')" class="bg-gray-100 p-4 cursor-pointer rounded-t-xl">' +
                '<div class="flex justify-between items-start">' +
                  '<div class="flex-1">' +
                    '<p class="font-bold text-gray-800">ë§¤ë„ì™„ë£Œ ' + p.id + 'ì°¨</p>' +
                    '<p class="text-xs text-gray-600">ë§¤ë„ì¼: ' + p.sellDate + '</p>' +
                    '<p class="text-sm font-bold mt-1 ' + (pr >= 0 ? 'text-red-600' : 'text-blue-600') + '">' +
                      'ì‹¤í˜„: ' + (pr >= 0 ? '+' : '') + (pr / 10000).toFixed(1) + 'ë§Œì› (' + ((pr / p.amount) * 100).toFixed(2) + '%)' +
                    '</p>' +
                  '</div>' +
                  '<i data-lucide="' + (isExpanded ? 'chevron-up' : 'chevron-down') + '" class="w-5 h-5"></i>' +
                '</div>' +
              '</div>' +
              (isExpanded ? '<div class="p-4 bg-gray-50 space-y-3 rounded-b-xl">' +
                '<input type="number" id="phase-amount-' + p.id + '" value="' + p.amount + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ê¸ˆì•¡">' +
                '<input type="number" id="phase-buyRate-' + p.id + '" value="' + p.buyRate + '" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ìˆ˜í™˜ìœ¨">' +
                '<input type="number" id="phase-sellRate-' + p.id + '" value="' + p.sellRate + '" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ë„í™˜ìœ¨">' +
                '<input type="date" id="phase-date-' + p.id + '" value="' + p.date + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ì¼">' +
                '<input type="date" id="phase-sellDate-' + p.id + '" value="' + p.sellDate + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ë„ì¼">' +
                '<button onclick="deleteExchangePhase(' + p.id + ')" class="w-full bg-red-500 text-white py-2 rounded flex items-center justify-center gap-2">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i> ì‚­ì œ' +
                '</button>' +
              '</div>' : '') +
            '</div>';
          }).join('') +
          (sold.length > state.soldItemsVisible ? 
            '<button onclick="state.soldItemsVisible+=10;render()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium">ë”ë³´ê¸° (' + (sold.length - state.soldItemsVisible) + 'ê±´)</button>' : '') +
        '</div>';
      }

      // Stats section
      var statsHtml = '';
      if (state.showExchangeStats) {
        var soldForStats = phases.filter(function(p) { return p.sold && p.sellDate; });
        if (state.exchangeStatsStartDate || state.exchangeStatsEndDate) {
          soldForStats = soldForStats.filter(function(p) {
            var sellDate = new Date(p.sellDate);
            var start = state.exchangeStatsStartDate ? new Date(state.exchangeStatsStartDate) : new Date('1900-01-01');
            var end = state.exchangeStatsEndDate ? new Date(state.exchangeStatsEndDate) : new Date('2100-12-31');
            return sellDate >= start && sellDate <= end;
          });
        }

        var grouped = {};
        soldForStats.forEach(function(p) {
          var d = new Date(p.sellDate);
          var key;
          if (state.exchangeStatsPeriod === 'daily') key = p.sellDate;
          else if (state.exchangeStatsPeriod === 'weekly') key = d.getFullYear() + '-W' + Math.ceil(((d - new Date(d.getFullYear(), 0, 1)) / 86400000 + new Date(d.getFullYear(), 0, 1).getDay() + 1) / 7);
          else if (state.exchangeStatsPeriod === 'monthly') key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          else key = String(d.getFullYear());
          
          if (!grouped[key]) grouped[key] = { period: key, count: 0, inv: 0, prof: 0 };
          var f = p.amount / p.buyRate;
          grouped[key].count += 1;
          grouped[key].inv += p.amount;
          grouped[key].prof += f * p.sellRate - p.amount;
        });

        var statsData = Object.values(grouped).sort(function(a, b) { return a.period.localeCompare(b.period); });
        var cumInv = 0, cumProf = 0;
        statsData = statsData.map(function(item) {
          cumInv += item.inv;
          cumProf += item.prof;
          return {
            period: item.period,
            count: item.count,
            inv: item.inv,
            prof: item.prof,
            rate: ((item.prof / item.inv) * 100).toFixed(2),
            cumInv: cumInv,
            cumProf: cumProf,
            cumRate: ((cumProf / cumInv) * 100).toFixed(2)
          };
        }).reverse();

        var statsItemsHtml = '';
        if (statsData.length === 0) {
          statsItemsHtml = '<div class="text-center py-8"><p class="text-sm text-gray-500">ì„ íƒí•œ ê¸°ê°„ì— ë§¤ë„ ì™„ë£Œëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        } else {
          statsItemsHtml = statsData.map(function(s) {
            return '<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3 border">' +
              '<div class="flex justify-between items-start mb-2">' +
                '<div><p class="font-bold text-sm">' + s.period + '</p><p class="text-xs text-gray-600">ë§¤ë„ ' + s.count + 'ê±´</p></div>' +
                '<div class="px-2 py-1 rounded-lg ' + (parseFloat(s.rate) >= 0 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700') + '">' +
                  '<p class="text-xs font-bold">' + (parseFloat(s.rate) >= 0 ? '+' : '') + s.rate + '%</p>' +
                '</div>' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-2 mb-2">' +
                '<div class="bg-white rounded p-2"><p class="text-xs text-gray-600">íˆ¬ìê¸ˆ</p><p class="font-bold text-sm text-blue-600">' + (s.inv / 10000).toFixed(0) + 'ë§Œ</p></div>' +
                '<div class="bg-white rounded p-2"><p class="text-xs text-gray-600">ì‹¤í˜„ìˆ˜ìµ</p><p class="font-bold text-sm ' + (s.prof >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (s.prof >= 0 ? '+' : '') + (s.prof / 10000).toFixed(1) + 'ë§Œ</p></div>' +
              '</div>' +
              '<div class="border-t pt-2">' +
                '<p class="text-xs font-semibold text-gray-700 mb-1">ëˆ„ì  í˜„í™©</p>' +
                '<div class="grid grid-cols-3 gap-2">' +
                  '<div class="bg-indigo-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì íˆ¬ì</p><p class="font-bold text-xs text-indigo-600">' + (s.cumInv / 10000).toFixed(0) + 'ë§Œ</p></div>' +
                  '<div class="bg-pink-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì ìˆ˜ìµ</p><p class="font-bold text-xs ' + (s.cumProf >= 0 ? 'text-pink-600' : 'text-blue-600') + '">' + (s.cumProf >= 0 ? '+' : '') + (s.cumProf / 10000).toFixed(1) + 'ë§Œ</p></div>' +
                  '<div class="bg-amber-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì ë¥ </p><p class="font-bold text-xs ' + (s.cumProf >= 0 ? 'text-amber-600' : 'text-blue-600') + '">' + (parseFloat(s.cumRate) >= 0 ? '+' : '') + s.cumRate + '%</p></div>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('');
        }

        statsHtml = '<div class="bg-white rounded-xl shadow-lg p-4 mb-3">' +
          '<div class="mb-4">' +
            '<div class="flex justify-between items-center mb-3">' +
              '<h3 class="font-bold text-gray-800 text-sm">ğŸ“Š ê¸°ê°„ë³„ íˆ¬ì í†µê³„</h3>' +
              '<div class="flex gap-1">' +
                '<button onclick="setExchangeStatsPeriod(\'daily\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'daily' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì¼</button>' +
                '<button onclick="setExchangeStatsPeriod(\'weekly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'weekly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì£¼</button>' +
                '<button onclick="setExchangeStatsPeriod(\'monthly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'monthly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì›”</button>' +
                '<button onclick="setExchangeStatsPeriod(\'yearly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'yearly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ë…„</button>' +
              '</div>' +
            '</div>' +
            '<div class="mb-3 p-3 bg-gray-50 rounded-lg">' +
              '<p class="text-xs font-semibold text-gray-700 mb-2">ğŸ“… ê¸°ê°„ ê²€ìƒ‰</p>' +
              '<div class="grid grid-cols-2 gap-2">' +
                '<div><label class="text-xs text-gray-600 block mb-1">ì‹œì‘ì¼</label><input type="date" id="exchangeStatsStartDate" value="' + state.exchangeStatsStartDate + '" onchange="state.exchangeStatsStartDate=this.value;render()" class="w-full px-2 py-1 border rounded text-xs"></div>' +
                '<div><label class="text-xs text-gray-600 block mb-1">ì¢…ë£Œì¼</label><input type="date" id="exchangeStatsEndDate" value="' + state.exchangeStatsEndDate + '" onchange="state.exchangeStatsEndDate=this.value;render()" class="w-full px-2 py-1 border rounded text-xs"></div>' +
              '</div>' +
              ((state.exchangeStatsStartDate || state.exchangeStatsEndDate) ? 
                '<button onclick="state.exchangeStatsStartDate=\'\';state.exchangeStatsEndDate=\'\';render()" class="mt-2 w-full bg-gray-300 text-gray-700 py-1 rounded text-xs font-medium">ê¸°ê°„ ì´ˆê¸°í™”</button>' : '') +
            '</div>' +
          '</div>' +
          '<div class="space-y-3">' + statsItemsHtml + '</div>' +
        '</div>';
      }

      return '<div class="p-3 space-y-3">' +
        '<div class="bg-white rounded-2xl shadow-lg p-2 flex gap-2">' +
          '<button onclick="setExchangeTab(\'USD\')" class="flex-1 py-3 rounded-xl font-bold transition ' + (state.exchangeTab === 'USD' ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' : 'bg-gray-100 text-gray-600') + '">ğŸ‡ºğŸ‡¸ USD</button>' +
          '<button onclick="setExchangeTab(\'JPY\')" class="flex-1 py-3 rounded-xl font-bold transition ' + (state.exchangeTab === 'JPY' ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white' : 'bg-gray-100 text-gray-600') + '">ğŸ‡¯ğŸ‡µ JPY</button>' +
        '</div>' +

        '<div class="bg-white rounded-2xl shadow-lg p-4">' +
          '<div class="text-sm text-gray-500 mb-1 text-center">' + (state.exchangeTab === 'USD' ? '1ë‹¬ëŸ¬ë‹¹' : '100ì—”ë‹¹') + '</div>' +
          '<div class="flex items-center justify-center gap-3">' +
            '<span class="text-4xl font-bold text-blue-600">' + currentRate.toFixed(2) + '</span>' +
            '<span class="text-2xl font-bold text-gray-600">ì›</span>' +
            '<button onclick="editExchangeRate()" class="text-blue-600 p-2"><i data-lucide="edit-2" class="w-6 h-6"></i></button>' +
            '<button onclick="fetchExchangeRate()" class="text-green-600 p-2" id="refreshRateBtn"><i data-lucide="refresh-cw" class="w-6 h-6"></i></button>' +
          '</div>' +
        '</div>' +

        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex items-center justify-between mb-3">' +
            '<div class="flex items-center gap-2">' +
              '<i data-lucide="dollar-sign" class="w-7 h-7 text-green-600"></i>' +
              '<div><h1 class="text-lg font-bold text-gray-800">' + state.exchangeTab + ' ë¶„í• ë§¤ìˆ˜</h1><p class="text-xs text-gray-500">íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤</p></div>' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-2 mb-2">' +
            '<div onclick="editInitialBudget()" class="bg-blue-50 rounded-lg p-2.5 cursor-pointer hover:bg-blue-100 transition"><p class="text-xs text-gray-600 mb-1">ì´ˆê¸°ì˜ˆì‚° âœï¸</p><p class="font-bold text-sm text-blue-600">' + (initialBudget / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-purple-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">í˜„ì¬ì˜ˆì‚°</p><p class="font-bold text-sm text-purple-600">' + ((initialBudget + profit) / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
          '</div>' +
          '<div class="grid grid-cols-3 gap-2">' +
            '<div class="bg-indigo-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì íˆ¬ì</p><p class="font-bold text-sm text-indigo-600">' + (cumInvested / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-green-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì ë‹¬ëŸ¬</p><p class="font-bold text-sm text-green-600">$' + totalUsd.toFixed(2) + '</p></div>' +
            '<div class="bg-red-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì ì—”í™”</p><p class="font-bold text-sm text-red-600">Â¥' + totalJpy.toFixed(0) + '</p></div>' +
          '</div>' +
        '</div>' +

        '<div class="' + gradeInfo.bg + ' rounded-xl shadow-lg p-4">' +
          '<div class="flex flex-col items-center">' +
            '<div class="flex items-center justify-center gap-2 mb-3">' +
              '<i data-lucide="trophy" class="w-6 h-6 ' + gradeInfo.color + '"></i>' +
              '<h3 class="text-xl font-bold ' + gradeInfo.color + '">íˆ¬ì ë“±ê¸‰: ' + gradeInfo.grade + '</h3>' +
            '</div>' +
            '<div class="w-full bg-white bg-opacity-50 rounded-lg p-3">' +
              '<div class="text-center">' +
                '<p class="text-xs text-gray-600 mb-1">ëˆ„ì  ì‹¤í˜„ìˆ˜ìµ (ë§¤ë„ì™„ë£Œ)</p>' +
                '<p class="text-2xl font-bold ' + (totalSoldProf >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (totalSoldProf >= 0 ? '+' : '') + Math.round(totalSoldProf).toLocaleString() + 'ì›</p>' +
                '<p class="text-sm font-semibold mt-1 ' + (totalSoldProf >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + (totalSoldProf >= 0 ? '+' : '') + (totalSoldInv > 0 ? ((totalSoldProf / totalSoldInv) * 100).toFixed(2) : 0) + '%</p>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +

        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold text-gray-800 mb-3 text-sm">ğŸ“Š íˆ¬ì í˜„í™©</h3>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div class="bg-blue-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">ì´ íˆ¬ìê¸ˆ</p><p class="font-bold text-blue-600">' + (invested / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-green-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">ë³´ìœ  ' + state.exchangeTab + '</p><p class="font-bold text-green-600">' + sym + (state.exchangeTab === 'USD' ? foreign.toFixed(2) : foreign.toFixed(0)) + '</p></div>' +
            '<div class="bg-purple-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">í‰ê·  ë§¤ìˆ˜ê°€</p><p class="font-bold text-purple-600">' + avgRate + 'ì›</p></div>' +
            '<div class="bg-orange-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">í‰ê°€ì†ìµ</p><p class="font-bold ' + (unrealized >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (unrealized >= 0 ? '+' : '') + (unrealized / 10000).toFixed(1) + 'ë§Œì›</p></div>' +
          '</div>' +
        '</div>' +

        '<button onclick="state.showExchangeStats=!state.showExchangeStats;render()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">' +
          '<i data-lucide="bar-chart-3" class="w-5 h-5"></i>' +
          (state.showExchangeStats ? 'í†µê³„ ìˆ¨ê¸°ê¸°' : 'ê¸°ê°„ë³„ í†µê³„ ë³´ê¸°') +
        '</button>' +

        statsHtml +

        '<button onclick="addExchangePhase()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">' +
          '<i data-lucide="plus" class="w-5 h-5"></i> ìƒˆ ë§¤ìˆ˜ ì¶”ê°€' +
        '</button>' +

        '<div class="space-y-3">' + activeHtml + '</div>' +
        soldHtml +
      '</div>';
    }

    function setExchangeTab(tab) {
      state.exchangeTab = tab;
      state.expandedPhase = null;
      render();
    }

    function setExchangeStatsPeriod(period) {
      state.exchangeStatsPeriod = period;
      render();
    }

    function editExchangeRate() {
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var newRate = prompt('í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”:', currentRate);
      if (newRate === null) return;
      var rate = parseFloat(newRate);
      if (isNaN(rate) || rate <= 0) { alert('ì˜¬ë°”ë¥¸ í™˜ìœ¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (state.exchangeTab === 'USD') state.usdRate = rate;
      else state.jpyRate = rate;
      saveData();
      render();
      showToast('í™˜ìœ¨ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function fetchExchangeRate() {
      var btn = document.getElementById('refreshRateBtn');
      if (btn) btn.innerHTML = '<i data-lucide="refresh-cw" class="w-6 h-6 animate-spin"></i>';
      
      fetch('https://api.exchangerate-api.com/v4/latest/KRW')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.rates.USD && data.rates.JPY) {
            state.usdRate = Math.round((1 / data.rates.USD) * 10) / 10;
            state.jpyRate = Math.round((100 / data.rates.JPY) * 100) / 100;
            saveData();
            render();
            showToast('í™˜ìœ¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
          }
        })
        .catch(function(e) {
          showToast('í™˜ìœ¨ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        });
    }

    function addExchangePhase() {
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      
      // Calculate current budget (initial + realized profits)
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { 
        return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); 
      }, 0);
      var currentBudget = initialBudget + profit;
      
      // Calculate total invested (completed but not sold) + pending (not completed)
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var pending = phases.filter(function(p) { return !p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalNeeded = invested + pending + 1000000; // Adding new 1,000,000 purchase
      
      // Check if total investment would exceed current budget
      if (totalNeeded > currentBudget) {
        var available = currentBudget - invested - pending;
        alert('ì˜ˆì‚° ì´ˆê³¼!\n\ní˜„ì¬ ì˜ˆì‚°: ' + Math.round(currentBudget).toLocaleString() + 'ì›\nì´ë¯¸ íˆ¬ìì¤‘: ' + (invested + pending).toLocaleString() + 'ì›\nì‚¬ìš© ê°€ëŠ¥: ' + Math.round(available).toLocaleString() + 'ì›\n\në§¤ìˆ˜ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ì´ˆê¸°ì˜ˆì‚°ì„ ëŠ˜ë¦¬ê±°ë‚˜ ê¸°ì¡´ ë§¤ìˆ˜ë¥¼ ë§¤ë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      var newPhase = {
        id: state.exchangeTab === 'USD' ? state.usdNextId : state.jpyNextId,
        amount: 1000000,
        buyRate: currentRate,
        sellRate: currentRate + 1.5,
        completed: false,
        sold: false,
        date: '',
        sellDate: ''
      };
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases.push(newPhase);
        state.usdNextId++;
      } else {
        state.jpyPhases.push(newPhase);
        state.jpyNextId++;
      }
      
      state.expandedPhase = newPhase.id;
      saveData();
      render();
      showToast('ìƒˆ ë§¤ìˆ˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function toggleExpandPhase(id) {
      state.expandedPhase = state.expandedPhase === id ? null : id;
      render();
    }

    function saveExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase) return;
      
      var amountEl = document.getElementById('phase-amount-' + id);
      var buyRateEl = document.getElementById('phase-buyRate-' + id);
      var sellRateEl = document.getElementById('phase-sellRate-' + id);
      
      if (amountEl) phase.amount = parseFloat(amountEl.value) || phase.amount;
      if (buyRateEl) phase.buyRate = parseFloat(buyRateEl.value) || phase.buyRate;
      if (sellRateEl) phase.sellRate = parseFloat(sellRateEl.value) || phase.sellRate;
      
      saveData();
      render();
      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function completeExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase) return;
      
      // Save phase data first
      saveExchangePhase(id);
      
      // Check budget before completing
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { 
        return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); 
      }, 0);
      var currentBudget = initialBudget + profit;
      
      // Calculate total that would be invested after completing this phase
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalAfterComplete = invested + phase.amount;
      
      if (totalAfterComplete > currentBudget) {
        var available = currentBudget - invested;
        alert('ì˜ˆì‚° ì´ˆê³¼!\n\ní˜„ì¬ ì˜ˆì‚°: ' + Math.round(currentBudget).toLocaleString() + 'ì›\nì´ë¯¸ íˆ¬ìì¤‘: ' + invested.toLocaleString() + 'ì›\nì‚¬ìš© ê°€ëŠ¥: ' + Math.round(available).toLocaleString() + 'ì›\nì´ ë§¤ìˆ˜ ê¸ˆì•¡: ' + phase.amount.toLocaleString() + 'ì›\n\në§¤ìˆ˜ë¥¼ ì™„ë£Œí•˜ë ¤ë©´ ì´ˆê¸°ì˜ˆì‚°ì„ ëŠ˜ë¦¬ê±°ë‚˜ ë§¤ìˆ˜ ê¸ˆì•¡ì„ ì¤„ì—¬ì£¼ì„¸ìš”.');
        return;
      }
      
      phase.completed = true;
      phase.date = new Date().toISOString().split('T')[0];
      
      saveData();
      render();
      showToast('ë§¤ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function sellExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase || !phase.completed) { alert('ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!'); return; }
      
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      phase.sold = true;
      phase.sellDate = new Date().toISOString().split('T')[0];
      phase.sellRate = currentRate;
      
      saveData();
      render();
      showToast('ë§¤ë„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteExchangePhase(id) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases = state.usdPhases.filter(function(p) { return p.id !== id; });
      } else {
        state.jpyPhases = state.jpyPhases.filter(function(p) { return p.id !== id; });
      }
      
      saveData();
      render();
      showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editInitialBudget() {
      var currentBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var newBudget = prompt('ì´ˆê¸°ì˜ˆì‚°ì„ ì…ë ¥í•˜ì„¸ìš” (ì›):', currentBudget);
      if (newBudget === null) return;
      var budget = parseInt(newBudget);
      if (isNaN(budget) || budget <= 0) { 
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); 
        return; 
      }
      if (state.exchangeTab === 'USD') {
        state.usdInitialBudget = budget;
      } else {
        state.jpyInitialBudget = budget;
      }
      saveData();
      render();
      showToast('ì´ˆê¸°ì˜ˆì‚°ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // Add Transaction Modal
    function renderAddTransactionModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddTransaction=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ê±°ë˜ ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div class="flex gap-2">' +
              '<button id="btn-expense" onclick="setTxType(\'expense\')" class="flex-1 py-2 rounded-lg bg-red-500 text-white">ì§€ì¶œ</button>' +
              '<button id="btn-income" onclick="setTxType(\'income\')" class="flex-1 py-2 rounded-lg bg-gray-200">ìˆ˜ì…</button>' +
            '</div>' +
            '<input type="hidden" id="txType" value="expense">' +
            '<div><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="txDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-2 border rounded-lg"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ê¸ˆì•¡</label><input type="number" id="txAmount" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>' +
            '<div id="expense-options">' +
              '<div><label class="block text-sm font-medium mb-1">ê²°ì œìˆ˜ë‹¨</label><select id="txPayment" onchange="toggleInstallment()" class="w-full p-2 border rounded-lg"><option value="card">ì¹´ë“œ</option><option value="cash">í˜„ê¸ˆ</option></select></div>' +
              '<div id="installment-div" class="mt-4"><label class="block text-sm font-medium mb-1">í• ë¶€</label><select id="txInstallment" class="w-full p-2 border rounded-lg"><option value="0">ì¼ì‹œë¶ˆ</option><option value="2">2ê°œì›”</option><option value="3">3ê°œì›”</option><option value="6">6ê°œì›”</option><option value="12">12ê°œì›”</option><option value="24">24ê°œì›”</option></select></div>' +
              '<div class="mt-4"><label class="block text-sm font-medium mb-1">ì§€ì¶œ ìœ í˜•</label>' +
                '<div class="flex gap-2">' +
                  '<button id="btn-necessary" onclick="setNecessary(true)" class="flex-1 py-2 rounded-lg bg-blue-500 text-white">í•„ìš”ì§€ì¶œ</button>' +
                  '<button id="btn-unnecessary" onclick="setNecessary(false)" class="flex-1 py-2 rounded-lg bg-gray-200">ë¶ˆí•„ìš”ì§€ì¶œ</button>' +
                '</div>' +
                '<input type="hidden" id="txNecessary" value="true">' +
              '</div>' +
            '</div>' +
            '<div><label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label><select id="txCategory" class="w-full p-2 border rounded-lg"><option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories.expense.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('') + '</select></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë©”ëª¨</label><textarea id="txMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="ë©”ëª¨ ì…ë ¥"></textarea></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="submitTransaction()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium">ì €ì¥</button>' +
              '<button onclick="state.showAddTransaction=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    var currentTxType = 'expense';
    var isNecessary = true;

    function setTxType(type) {
      currentTxType = type;
      document.getElementById('txType').value = type;
      document.getElementById('btn-expense').className = type === 'expense' ? 'flex-1 py-2 rounded-lg bg-red-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('btn-income').className = type === 'income' ? 'flex-1 py-2 rounded-lg bg-green-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('expense-options').style.display = type === 'expense' ? 'block' : 'none';
      
      var catSelect = document.getElementById('txCategory');
      catSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories[type].map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('');
    }

    function setNecessary(val) {
      isNecessary = val;
      document.getElementById('txNecessary').value = val;
      document.getElementById('btn-necessary').className = val ? 'flex-1 py-2 rounded-lg bg-blue-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('btn-unnecessary').className = !val ? 'flex-1 py-2 rounded-lg bg-gray-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
    }

    function toggleInstallment() {
      var payment = document.getElementById('txPayment').value;
      document.getElementById('installment-div').style.display = payment === 'card' ? 'block' : 'none';
    }

    function submitTransaction() {
      var type = document.getElementById('txType').value;
      var date = document.getElementById('txDate').value;
      var amount = Number(document.getElementById('txAmount').value);
      var category = document.getElementById('txCategory').value;
      var memo = document.getElementById('txMemo').value;
      
      if (!category) { alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      if (!amount || amount <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      state.transactions.push({
        id: Date.now(),
        type: type,
        date: date,
        amount: amount,
        category: category,
        memo: memo,
        paymentMethod: type === 'expense' ? document.getElementById('txPayment').value : 'cash',
        installment: type === 'expense' && document.getElementById('txPayment').value === 'card' ? Number(document.getElementById('txInstallment').value) : 0,
        isNecessary: type === 'expense' ? document.getElementById('txNecessary').value === 'true' : true
      });

      state.showAddTransaction = false;
      saveData();
      render();
      showToast('ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // Add Dividend Modal
    function renderAddDividendModal() {
      var stockOptions = state.investments.map(function(inv) {
        return '<option value="' + inv.name + '">' + inv.name + '</option>';
      }).join('');

      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddDividend=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md shadow-2xl">' +
          '<div class="p-4 border-b bg-green-50 rounded-t-xl"><h2 class="text-xl font-bold text-green-700">ğŸ’° ë°°ë‹¹ ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ì¢…ëª©ëª…</label>' +
              '<input type="text" id="divStockName" class="w-full p-3 border rounded-lg" placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">' +
              (stockOptions ? '<div class="mt-2"><select onchange="document.getElementById(\'divStockName\').value=this.value" class="w-full p-2 border rounded-lg text-sm bg-gray-50"><option value="">-- ë³´ìœ ì¢…ëª©ì—ì„œ ì„ íƒ --</option>' + stockOptions + '</select></div>' : '') +
            '</div>' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ë°°ë‹¹ì¼</label>' +
              '<input type="date" id="divDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-3 border rounded-lg">' +
            '</div>' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ë°°ë‹¹ê¸ˆ</label>' +
              '<div class="relative">' +
                '<input type="number" id="divAmount" class="w-full p-3 pr-12 border rounded-lg" placeholder="0">' +
                '<span class="absolute right-3 top-3 text-gray-500">ì›</span>' +
              '</div>' +
            '</div>' +
            '<div class="flex gap-2 pt-2">' +
              '<button onclick="addDividend()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-bold transition">ë°°ë‹¹ ì¶”ê°€</button>' +
              '<button onclick="state.showAddDividend=false;render()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-medium transition">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Add Journal Modal
    function renderAddJournalModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddJournal=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ğŸ“ íˆ¬ìì¼ì§€ ì‘ì„±</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="journalDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-2 border rounded-lg"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë‚´ìš©</label><textarea id="journalContent" class="w-full p-2 border rounded-lg" rows="6" placeholder="ì˜¤ëŠ˜ì˜ íˆ¬ì ìƒê°, ë§¤ë§¤ ì´ìœ , ì‹œì¥ ë¶„ì„ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="addJournal()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg font-medium">ì €ì¥</button>' +
              '<button onclick="state.showAddJournal=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Add Investment Modal
    function renderAddInvestmentModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddInvestment=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ğŸ“ˆ íˆ¬ì ì¢…ëª© ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div><label class="block text-sm font-medium mb-1">ì¢…ëª©ëª…</label><input type="text" id="invName" class="w-full p-2 border rounded-lg" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"></div>' +
            '<div><label class="block text-sm font-medium mb-1">íˆ¬ì ìœ í˜•</label><select id="invType" class="w-full p-2 border rounded-lg"><option value="stock">ğŸ“Š ì£¼ì‹</option><option value="etf">ğŸ“¦ ETF</option><option value="fund">ğŸ’¼ í€ë“œ</option><option value="crypto">ğŸª™ ì•”í˜¸í™”í</option><option value="gold">ğŸ¥‡ ê¸ˆ</option><option value="realestate">ğŸ  ë¶€ë™ì‚°</option><option value="bond">ğŸ“ƒ ì±„ê¶Œ</option><option value="other">ğŸ“„ ê¸°íƒ€</option></select></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="number" id="invQuantity" class="w-full p-2 border rounded-lg" placeholder="0"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë§¤ì…ê°€ (1ì£¼ë‹¹)</label><input type="number" id="invBuyPrice" class="w-full p-2 border rounded-lg" placeholder="0"></div>' +
            '<div><label class="block text-sm font-medium mb-1">í˜„ì¬ê°€ (1ì£¼ë‹¹)</label><input type="number" id="invCurrentPrice" class="w-full p-2 border rounded-lg" placeholder="ë§¤ì…ê°€ì™€ ë™ì¼ì‹œ ë¹„ì›Œë‘ì„¸ìš”"></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="addInvestment()" class="flex-1 bg-indigo-500 text-white py-3 rounded-lg font-medium">ì¶”ê°€</button>' +
              '<button onclick="state.showAddInvestment=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Compound Calculator Modal
    function renderCompoundCalc() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showCompoundCalc=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">ğŸ’° ì ë¦½ì‹ ë³µë¦¬ê³„ì‚°ê¸°</h2><button onclick="state.showCompoundCalc=false;render()" class="text-gray-500 text-2xl">âœ•</button></div>' +
          '<div class="p-4 space-y-4">' +
            '<div><label class="block text-sm font-medium mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ</label><input type="number" id="calcInitial" class="w-full p-3 border rounded-lg" placeholder="0"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ì›” ì ë¦½ê¸ˆ</label><input type="number" id="calcMonthly" class="w-full p-3 border rounded-lg" placeholder="0"></div>' +
            '<div><label class="block text-sm font-medium mb-1">íˆ¬ì ê¸°ê°„ (ë…„)</label><input type="number" id="calcYears" class="w-full p-3 border rounded-lg" placeholder="0"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ì—° ìˆ˜ìµë¥  (%)</label><input type="number" step="0.1" id="calcRate" class="w-full p-3 border rounded-lg" placeholder="0"></div>' +
            '<button onclick="calculateCompound()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold">ê³„ì‚°í•˜ê¸°</button>' +
            '<div id="calc-result"></div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function calculateCompound() {
      var initial = Number(document.getElementById('calcInitial').value) || 0;
      var monthly = Number(document.getElementById('calcMonthly').value) || 0;
      var years = Number(document.getElementById('calcYears').value) || 0;
      var rate = Number(document.getElementById('calcRate').value) / 100 || 0;

      if (years === 0) { alert('ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      var currentAmount = initial;
      for (var year = 1; year <= years; year++) {
        for (var month = 1; month <= 12; month++) {
          currentAmount += monthly;
          currentAmount = currentAmount * (1 + rate / 12);
        }
      }

      var finalAmount = Math.round(currentAmount);
      var totalDeposit = initial + (monthly * 12 * years);
      var totalInterest = finalAmount - totalDeposit;

      document.getElementById('calc-result').innerHTML = '<div class="bg-gradient-to-r from-purple-100 to-blue-100 p-5 rounded-xl shadow-lg mt-4">' +
        '<h3 class="font-bold text-lg mb-4 text-center text-purple-700">ìµœì¢… ê²°ê³¼</h3>' +
        '<div class="grid grid-cols-3 gap-3">' +
          '<div class="bg-white p-3 rounded-lg text-center shadow"><div class="text-xs text-gray-600">ìµœì¢… ê¸ˆì•¡</div><div class="font-bold text-purple-600">' + formatNumber(finalAmount) + 'ì›</div></div>' +
          '<div class="bg-white p-3 rounded-lg text-center shadow"><div class="text-xs text-gray-600">ì´ ë‚©ì…ê¸ˆ</div><div class="font-bold text-blue-600">' + formatNumber(totalDeposit) + 'ì›</div></div>' +
          '<div class="bg-white p-3 rounded-lg text-center shadow"><div class="text-xs text-gray-600">ì´ ì´ì</div><div class="font-bold text-green-600">' + formatNumber(totalInterest) + 'ì›</div></div>' +
        '</div>' +
      '</div>';
    }

    // Settings Modal
    function renderSettings() {
      var categoryListHtml = state.categories[currentCatType].map(function(c, i) {
        return '<div class="flex justify-between items-center p-2 border rounded bg-gray-50">' +
          '<span>' + c + '</span>' +
          '<button onclick="deleteCategory(\'' + currentCatType + '\',' + i + ')" class="text-red-500 text-sm px-2">ì‚­ì œ</button>' +
        '</div>';
      }).join('');

      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSettings=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">âš™ï¸ ì„¤ì •</h2><button onclick="state.showSettings=false;render()" class="text-gray-500 text-2xl">âœ•</button></div>' +
          '<div class="p-4 space-y-6">' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>' +
              '<div class="flex gap-2 mb-4">' +
                '<button id="cat-expense-btn" onclick="setCatType(\'expense\')" class="flex-1 py-2 rounded-lg bg-red-500 text-white">ì§€ì¶œ</button>' +
                '<button id="cat-income-btn" onclick="setCatType(\'income\')" class="flex-1 py-2 rounded-lg bg-gray-200">ìˆ˜ì…</button>' +
              '</div>' +
              '<div class="space-y-2 mb-4 max-h-48 overflow-y-auto" id="category-list">' + categoryListHtml + '</div>' +
              '<div class="flex gap-2">' +
                '<input type="text" id="newCatName" class="flex-1 p-2 border rounded-lg" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„">' +
                '<button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">ì¶”ê°€</button>' +
              '</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3>' +
              '<div class="space-y-3">' +
                '<button onclick="exportData()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium">ë°ì´í„° ë°±ì—… (JSON)</button>' +
                '<button onclick="exportToCSV()" class="w-full bg-green-500 text-white py-3 rounded-lg font-medium">ê±°ë˜ë‚´ì—­ ë‚´ë³´ë‚´ê¸° (CSV)</button>' +
                '<input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">' +
                '<button onclick="document.getElementById(\'importFile\').click()" class="w-full bg-purple-500 text-white py-3 rounded-lg font-medium">ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON)</button>' +
                '<button onclick="resetAllData()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>' +
              '</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-2">ì•± ì •ë³´</h3>' +
              '<div class="text-sm text-gray-600 space-y-1">' +
                '<p>ë²„ì „: 2.0</p>' +
                '<p>ì´ ê±°ë˜: ' + state.transactions.length + 'ê±´</p>' +
                '<p>ì´ íˆ¬ì: ' + state.investments.length + 'ê°œ</p>' +
                '<p>USD ê±°ë˜: ' + state.usdPhases.length + 'ê±´</p>' +
                '<p>JPY ê±°ë˜: ' + state.jpyPhases.length + 'ê±´</p>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    var currentCatType = 'expense';

    function setCatType(type) {
      currentCatType = type;
      var expBtn = document.getElementById('cat-expense-btn');
      var incBtn = document.getElementById('cat-income-btn');
      if (expBtn) expBtn.className = type === 'expense' ? 'flex-1 py-2 rounded-lg bg-red-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      if (incBtn) incBtn.className = type === 'income' ? 'flex-1 py-2 rounded-lg bg-green-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      updateCategoryList();
    }

    function updateCategoryList() {
      var listEl = document.getElementById('category-list');
      if (!listEl) return;
      listEl.innerHTML = state.categories[currentCatType].map(function(c, i) {
        return '<div class="flex justify-between items-center p-2 border rounded bg-gray-50">' +
          '<span>' + c + '</span>' +
          '<button onclick="deleteCategory(\'' + currentCatType + '\',' + i + ')" class="text-red-500 text-sm px-2">ì‚­ì œ</button>' +
        '</div>';
      }).join('');
    }

    function addCategory() {
      var nameEl = document.getElementById('newCatName');
      var name = nameEl ? nameEl.value.trim() : '';
      if (!name) { alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.categories[currentCatType].push(name);
      saveData();
      nameEl.value = '';
      updateCategoryList();
      showToast('ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteCategory(type, index) {
      if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.categories[type].splice(index, 1);
        saveData();
        updateCategoryList();
        showToast('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function resetAllData() {
      if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?') && confirm('ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤.')) {
        state.transactions = [];
        state.memos = [];
        state.events = [];
        state.bankBalances = [];
        state.investments = [];
        state.dividends = [];
        state.investmentJournals = [];
        state.goals = { year7: '', year5: '', year3: '', thisYear: '' };
        state.undoStack = [];
        state.usdPhases = [];
        state.jpyPhases = [];
        state.usdNextId = 1;
        state.jpyNextId = 1;
        saveData();
        state.showSettings = false;
        render();
        showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Render Navbar
    function renderNavbar() {
      var tabs = [
        { id: 'home', icon: 'home', label: 'í™ˆ' },
        { id: 'history', icon: 'file-text', label: 'ë‚´ì—­' },
        { id: 'stats', icon: 'bar-chart-3', label: 'í†µê³„' },
        { id: 'add', icon: 'plus', label: '' },
        { id: 'goal', icon: 'target', label: 'ëª©í‘œ' },
        { id: 'invest', icon: 'trending-up', label: 'íˆ¬ì' },
        { id: 'exchange', icon: 'coins', label: 'í™˜ì „' }
      ];

      var tabsHtml = tabs.map(function(t) {
        if (t.id === 'add') {
          return '<button onclick="state.showAddTransaction=true;render()" class="flex flex-col items-center p-2 -mt-8">' +
            '<div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full p-4 shadow-2xl hover:scale-110 transition transform">' +
              '<i data-lucide="plus" class="w-7 h-7" style="stroke-width: 3"></i>' +
            '</div>' +
          '</button>';
        }
        return '<button onclick="setActiveTab(\'' + t.id + '\')" class="flex flex-col items-center p-2 rounded-lg transition ' + (state.activeTab === t.id ? 'text-blue-600 bg-blue-50' : 'text-gray-400') + '">' +
          '<i data-lucide="' + t.icon + '" class="w-5 h-5"></i>' +
          '<span class="text-xs mt-1 font-medium">' + t.label + '</span>' +
        '</button>';
      }).join('');

      return '<div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl max-w-md mx-auto">' +
        '<div class="flex justify-around items-center p-2">' + tabsHtml + '</div>' +
      '</div>';
    }

    function setActiveTab(tab) {
      state.activeTab = tab;
      render();
    }

    // Main render function
    function render() {
      var app = document.getElementById('app');
      
      if (state.isLoading) {
        app.innerHTML = '<div class="flex items-center justify-center min-h-screen">' +
          '<div class="text-center">' +
            '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>' +
            '<div class="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</div>' +
          '</div>' +
        '</div>';
        return;
      }

      var content = '';
      if (state.activeTab === 'home') content = renderHomeScreen();
      else if (state.activeTab === 'history') content = renderHistoryScreen();
      else if (state.activeTab === 'stats') content = renderStatsScreen();
      else if (state.activeTab === 'goal') content = renderGoalScreen();
      else if (state.activeTab === 'invest') content = renderInvestmentScreen();
      else if (state.activeTab === 'exchange') content = renderExchangeScreen();

      var modals = '';
      if (state.showAddTransaction) modals += renderAddTransactionModal();
      if (state.showCompoundCalc) modals += renderCompoundCalc();
      if (state.showSettings) modals += renderSettings();
      if (state.showAddInvestment) modals += renderAddInvestmentModal();
      if (state.showAddDividend) modals += renderAddDividendModal();
      if (state.showAddJournal) modals += renderAddJournalModal();

      app.innerHTML = renderHeader() + '<div class="pb-4">' + content + '</div>' + renderNavbar() + modals;

      lucide.createIcons();

      // Post-render updates
      setTimeout(function() {
        if (state.activeTab === 'history') {
          updateHistoryList();
          var startDate = document.getElementById('startDate');
          var endDate = document.getElementById('endDate');
          var searchKeyword = document.getElementById('searchKeyword');
          if (startDate) startDate.addEventListener('change', updateHistoryList);
          if (endDate) endDate.addEventListener('change', updateHistoryList);
          if (searchKeyword) searchKeyword.addEventListener('input', updateHistoryList);
        }
        if (state.activeTab === 'stats') updateStatsContent();
      }, 0);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
    });
  </script>
</body>
</html>
